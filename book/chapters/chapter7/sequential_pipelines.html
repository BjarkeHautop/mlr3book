<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.276">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Applied Machine Learning Using mlr3 in R - 7&nbsp; Sequential Pipelines</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../chapters/chapter8/non-sequential_pipelines_and_tuning.html" rel="next">
<link href="../../chapters/chapter6/feature_selection.html" rel="prev">
<link href="../../Figures/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
</head>
<body class="nav-sidebar floating slimcontent">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../chapters/chapter7/sequential_pipelines.html">Pipelines and Preprocessing</a></li><li class="breadcrumb-item"><a href="../../chapters/chapter7/sequential_pipelines.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Sequential Pipelines</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Applied Machine Learning Using mlr3 in R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mlr-org/mlr3book/tree/main/book/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../../Applied-Machine-Learning-Using-mlr3-in-R.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter1/introduction_and_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction and Overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Fundamentals</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter2/data_and_basic_modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data and Basic Modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter3/evaluation_and_benchmarking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Evaluation and Benchmarking</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Tuning and Feature Selection</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter4/hyperparameter_optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Hyperparameter Optimization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter5/advanced_tuning_methods_and_black_box_optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Advanced Tuning Methods and Black Box Optimization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter6/feature_selection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Feature Selection</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Pipelines and Preprocessing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter7/sequential_pipelines.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Sequential Pipelines</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter8/non-sequential_pipelines_and_tuning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Non-sequential Pipelines and Tuning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter9/preprocessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Preprocessing</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter10/advanced_technical_aspects_of_mlr3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Advanced Technical Aspects of mlr3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter11/large-scale_benchmarking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Large-Scale Benchmarking</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter12/model_interpretation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Model Interpretation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter13/beyond_regression_and_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Beyond Regression and Classification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/chapter14/algorithmic_fairness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Algorithmic Fairness</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/citation_information.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Citation information</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/session_info.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Session Info</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/solutions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Solutions to exercises</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Tasks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/overview-tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Overview Tables</span></span></a>
  </div>
</li>
          <li class="px-0"><hr class="sidebar-divider hi "></li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/appendices/references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">F</span>&nbsp; <span class="chapter-title">References</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#sec-pipelines-intro" id="toc-sec-pipelines-intro" class="nav-link active" data-scroll-target="#sec-pipelines-intro"><span class="header-section-number">7.1</span> <code>mlr3pipelines</code> by Example</a></li>
  <li>
<a href="#sec-pipelines-pipeops" id="toc-sec-pipelines-pipeops" class="nav-link" data-scroll-target="#sec-pipelines-pipeops"><span class="header-section-number">7.2</span> <code>PipeOp</code>: Pipeline Operators</a>
  <ul class="collapse">
<li><a href="#creating-pipeops" id="toc-creating-pipeops" class="nav-link" data-scroll-target="#creating-pipeops"><span class="header-section-number">7.2.1</span> Creating <code>PipeOp</code>s</a></li>
  </ul>
</li>
  <li>
<a href="#sec-pipelines-graphs" id="toc-sec-pipelines-graphs" class="nav-link" data-scroll-target="#sec-pipelines-graphs"><span class="header-section-number">7.3</span> <code>Graph</code>: Networks of <code>PipeOp</code>s</a>
  <ul class="collapse">
<li><a href="#basics-building-a-graph" id="toc-basics-building-a-graph" class="nav-link" data-scroll-target="#basics-building-a-graph"><span class="header-section-number">7.3.1</span> Basics: Building a <code>Graph</code></a></li>
  <li><a href="#graphs-are-nodes-with-edges" id="toc-graphs-are-nodes-with-edges" class="nav-link" data-scroll-target="#graphs-are-nodes-with-edges"><span class="header-section-number">7.3.2</span> <code>Graph</code>s are Nodes with Edges</a></li>
  <li><a href="#using-a-graph" id="toc-using-a-graph" class="nav-link" data-scroll-target="#using-a-graph"><span class="header-section-number">7.3.3</span> Using a <code>Graph</code></a></li>
  <li><a href="#debugging-a-graph-with-intermediate-results" id="toc-debugging-a-graph-with-intermediate-results" class="nav-link" data-scroll-target="#debugging-a-graph-with-intermediate-results"><span class="header-section-number">7.3.4</span> Debugging a <code>Graph</code> with Intermediate Results</a></li>
  </ul>
</li>
  <li>
<a href="#sec-pipelines-sequential" id="toc-sec-pipelines-sequential" class="nav-link" data-scroll-target="#sec-pipelines-sequential"><span class="header-section-number">7.4</span> Sequential <code>Learner</code>-Pipelines</a>
  <ul class="collapse">
<li><a href="#accessing-pipeline-objects" id="toc-accessing-pipeline-objects" class="nav-link" data-scroll-target="#accessing-pipeline-objects"><span class="header-section-number">7.4.1</span> Accessing Pipeline Objects</a></li>
  <li><a href="#sec-pipelines-hyperparameters" id="toc-sec-pipelines-hyperparameters" class="nav-link" data-scroll-target="#sec-pipelines-hyperparameters"><span class="header-section-number">7.4.2</span> Pipeline Hyperparameters</a></li>
  <li><a href="#ids-and-name-clashes" id="toc-ids-and-name-clashes" class="nav-link" data-scroll-target="#ids-and-name-clashes"><span class="header-section-number">7.4.3</span> IDs and Name Clashes</a></li>
  </ul>
</li>
  <li><a href="#recap" id="toc-recap" class="nav-link" data-scroll-target="#recap"><span class="header-section-number">7.5</span> Recap</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">7.6</span> Exercises</a></li>
  <li><a href="#citation" id="toc-citation" class="nav-link" data-scroll-target="#citation"><span class="header-section-number">7.7</span> Citation</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mlr-org/mlr3book/edit/main/book/chapters/chapter7/sequential_pipelines.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/mlr-org/mlr3book/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/mlr-org/mlr3book/blob/main/book/chapters/chapter7/sequential_pipelines.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-pipelines" class="quarto-section-identifier"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Sequential Pipelines</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p><strong>Martin Binder</strong> <br><em>Ludwig-Maximilians-Universität München, and Munich Center for Machine Learning (MCML)</em></p>
<p><strong>Florian Pfisterer</strong> <br><em>Ludwig-Maximilians-Universität München</em> <br><br></p>
<p>Machine learning (ML) toolkits often try to abstract away the processes inside ML algorithms. These toolkits provide a layer of abstraction, allowing users to swap one algorithm for another without having to worry about specifics of each algorithm. The benefit of using <span class="refpkg"><a href="https://mlr3.mlr-org.com"><code>mlr3</code></a></span>, for example, is that one can use any <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a>, <a href="https://mlr3.mlr-org.com/reference/Task.html" class="refcode"><code>Task</code></a>, or <a href="https://mlr3.mlr-org.com/reference/Resampling.html" class="refcode"><code>Resampling</code></a> object and use them for typical ML operations, mostly independently of what algorithms or datasets they represent. In the following code snippet, it would be trivial to swap in a different learner than <a href="https://mlr3.mlr-org.com/reference/mlr_learners_regr.rpart.html" class="refcode"><code>lrn("regr.rpart")</code></a> without having to worry about implementation details:</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-002_730b304008e0bf284f2b9df9276048dc">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu">as_task_regr</span><span class="op">(</span><span class="va">cars</span>, target <span class="op">=</span> <span class="st">"dist"</span><span class="op">)</span></span>
<span><span class="va">learner_rpart</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.rpart"</span><span class="op">)</span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"holdout"</span><span class="op">)</span></span>
<span><span class="fu">resample</span><span class="op">(</span><span class="va">task</span>, <span class="va">learner_rpart</span>, <span class="va">resampling</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="page-columns page-full"><p>However, this modularity breaks down as soon as the learning process encompasses more than just model fitting, like data preprocessing, building ensemble-models or even more complicated meta-models. This is where <span class="refpkg"><a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a></span> <span class="citation" data-cites="mlr3pipelines">(<a href="#ref-mlr3pipelines" role="doc-biblioref">Binder et al. 2021</a>)</span> steps in: it takes modularity one step further than <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a> and makes it possible to build individual steps within a <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a> out of building blocks that manipulate data. Individual, frequently encountered building blocks, such as missing value imputation or majority vote ensembling, are provided as an (R6-)object, which we call a PipeOp. These PipeOps can be connected using directed edges inside a Graph (or “Pipeline”) to represent the flow of data between operations.</p><div class="no-row-height column-margin column-container"><span class="">Pipeop</span><span class="">Graph</span></div></div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="refcode"><code>Graph</code></a> class represents an object similar to a directed acyclic graph (DAG), since the input of a PipeOp can not depend on its output and hence cycles are not allowed. However, the resemblance to a DAG is not perfect, since the <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="refcode"><code>Graph</code></a> class allows for multiple edges between nodes. A term such as “directed acyclic multigraph” would be more accurate, but we will stick to the term “Graph” for simplicity.</p>
</div>
</div>
<p>Some examples of operations that can be performed with <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> are:</p>
<ul>
<li>Data manipulation and preprocessing operations, e.g.&nbsp;PCA, feature filtering, missing value imputation.</li>
<li>Task subsampling for speed or for handling of imbalanced classes.</li>
<li>Ensemble methods and aggregation of predictions.</li>
<li>Simultaneous model selection and hyperparameter tuning of both learners and preprocessing operators, by using <a href="https://mlr3tuning.mlr-org.com"><code>mlr3tuning</code></a>. This is sometimes facetiously referred to as “CASH”, standing for “Combined Algorithm Selection and Hyperparameter optimization” <span class="citation" data-cites="Thornton2013">(<a href="#ref-Thornton2013" role="doc-biblioref">Thornton et al. 2013</a>)</span>.</li>
</ul>
<p>During model training, the PipeOps in a Graph operate on a given dataset and transform it. PipeOps that come later in a Graph get the already transformed data as input. The Graph can therefore be thought of as a network representing function composition. However, besides transforming data, PipeOps also generate a <em>state</em>, similar to how learners train model parameters. This state is used to inform the PipeOp’s operation during prediction.</p>
<p>As a simple example, consider scaling features to have unit variance <code>po("scale", center = FALSE)</code> (<a href="#fig-pipelines-state">Figure&nbsp;<span class="quarto-unresolved-ref">fig-pipelines-state</span></a>). During training, it calculates and divides by the standard deviation of each feature. For prediction, it would be wrong to divide by the standard deviation of the <em>prediction</em> dataset; instead the same scaling factors as during training should be used. The PipeOp therefore stores the scaling factors of each feature in its state, to be used during prediction. Each PipeOp stores its own state independently of other PipeOps. A very simple sequential Graph that does various preprocessing operations before fitting a learner is displayed in <a href="#fig-pipelines-example">Figure&nbsp;<span class="quarto-unresolved-ref">fig-pipelines-example</span></a>&nbsp;(a). <a href="#fig-pipelines-example">Figure&nbsp;<span class="quarto-unresolved-ref">fig-pipelines-example</span></a>&nbsp;(b) shows a more elaborate pipeline that does alternative path branching.</p>
<div class="cell" data-layout-align="center" data-hash="sequential_pipelines_cache/html/fig-pipelines-state_f89b2d7713b3ba66cf9eb8c64998cf76">
<div class="cell-output-display">
<div id="fig-pipelines-state" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="Figures/state_graphic.svg" class="quarto-discovered-preview-image img-fluid figure-img" style="width:70.0%" alt="Traning data is transformed by a Scaling PipeOp, which also sets the state inside the PipeOp."></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;7.1: <code>$train()</code> of the “Scaling” PipeOp both transforms data (rectangles) as well as creates a state: the scaling factors, necessary to transform data during prediction.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>When evaluating the performance of an ML process consisting e.g.&nbsp;of preprocessing, followed by model fitting, it is strongly advised to always put the entire preprocessing operation <em>inside</em> the resampling loop, as is done here – <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> encourages this more accurate approach. Making a PCA on the entirety of a dataset, followed by resampling a learner on it, would effectively leak information from the training set to the test set, leading to biased results.</p>
<section id="sec-pipelines-intro" class="level2" data-number="7.1"><h2 data-number="7.1" class="anchored" data-anchor-id="sec-pipelines-intro">
<span class="header-section-number">7.1</span> <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> by Example</h2>
<p>In the following, we provide a brief example of <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> to give you a quick idea of what it is capable of. The dataflow programming concept implemented by <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> is very intuitive, and seeing a few code snippets will already give you a clear idea of how to use it. In subsequent chapters, we will elaborate on each of the concepts used here.</p>
<div id="fig-pipelines-example" class="cell quarto-layout-panel" data-hash="sequential_pipelines_cache/html/fig-pipelines-example_bf0b633f1e6e76e65cb86faa4a5e8948">
<figure class="figure"><div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-pipelines-example-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="Figures/single_pipe.svg" class="img-fluid figure-img" alt="Sequential pipeline that does scaling, factor encoding, and median imputation before fitting a model." data-ref-parent="fig-pipelines-example"></p>
<p></p><figcaption class="figure-caption">(a) Sequential pipeline.</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-pipelines-example-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="sequential_pipelines_files/figure-html/fig-pipelines-example-2.png" class="img-fluid figure-img" alt="Pipeline that feeds data into a &quot;branch&quot; operator, followed by, alternatively, &quot;null&quot;, &quot;pca&quot;, and &quot;scale&quot;. Outputs of these are combined into &quot;unbranch&quot;, followed by &quot;classif.rpart&quot;." data-ref-parent="fig-pipelines-example" width="672"></p>
<p></p><figcaption class="figure-caption">(b) Alternative path branching pipeline.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;7.2: Representations of different pipelines. (a): A simple sequential pipeline that does some preprocessing before feeding data to a learner. This graphic illustrates our conceptual representation style of a pipeline, which highlights data flows and relevant information about PipeOps. (b): A pipeline that offers three alternative preprocessing paths: Data can either be scaled, PCA-transformed, or not transformed at all (“null”) before being fed into the “classif.rpart” learner. By tuning the hyperparameter of the “branch” PipeOp, it is possible to discover which preprocessing operation leads to the best performance. This graphic shows the output of the <code>$plot()</code> method of a Graph object.</figcaption><p></p>
</figure>
</div>
<p>PipeOps can be easily created using the <a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="refcode"><code>po()</code></a> constructor function. Similar to learners, they have hyperparameters that can be set during construction as well as by using the <code>$param_set$values</code> field, as demonstrated in <a href="#sec-param-set"><span class="quarto-unresolved-ref">sec-param-set</span></a>. The following sets the <code>scale.</code> hyperparameter, which corresponds to the <code>scale.</code> argument of the <a href="https://www.rdocumentation.org/packages/stats/topics/prcomp" class="refcode"><code>prcomp()</code></a> function that underlies <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_pca.html" class="refcode"><code>po("pca")</code></a>:</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/pipeop-quickstart-library_56658f3f4cb296a3ad710709c4297379">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3pipelines.mlr-org.com">"mlr3pipelines"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">pca</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"pca"</span>, scale. <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>PipeOps can be combined to form Graphs. The simplest way to combine PipeOps is to use the <a href="https://mlr3pipelines.mlr-org.com/reference/%%3E%3E%.html" class="refcode"><code>%&gt;&gt;%</code></a>-operator. To create a Graph that trains a model, combine PipeOps with a <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a>. The <code>$plot()</code> method can be used to display the structure of the created Graph.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/pipeop-quickstart-graphs-1_cbe3607eb83199327cda6cd005d82247">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">graph</span> <span class="op">=</span> <span class="va">pca</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">graph</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>horizontal <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="sequential_pipelines_files/figure-html/pipeop-quickstart-graphs-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A Graph in which the last operation is a <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a> can itself be transformed into a learner, which performs the operations represented by the Graph in order, by using <a href="https://mlr3.mlr-org.com/reference/as_learner.html" class="refcode"><code>as_learner()</code></a>.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/pipeop-quickstart-graphlearner-1_c88fc605cabcf84aa98d148fef65227a">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">graph_learner</span> <span class="op">=</span> <span class="fu">as_learner</span><span class="op">(</span><span class="va">graph</span><span class="op">)</span></span>
<span></span>
<span><span class="va">graph_learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu">tsk</span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice how the decision variables in the model are not the columns of the original dataset, but rather the principal components extracted by <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_pca.html" class="refcode"><code>po("pca")</code></a>.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/pipeop-quickstart-graphlearner-1b_34286a1745b66a500a7a86770a037d5f">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">graph_learner</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">classif.rpart</span><span class="op">$</span><span class="va">model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 150 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

1) root 150 100 setosa (0.333 0.333 0.333)  
  2) PC1&lt; -1.15 50   0 setosa (1.000 0.000 0.000) *
  3) PC1&gt;=-1.15 100  50 versicolor (0.000 0.500 0.500)  
    6) PC1&lt; 1.1 50   5 versicolor (0.000 0.900 0.100) *
    7) PC1&gt;=1.1 50   5 virginica (0.000 0.100 0.900) *</code></pre>
</div>
</div>
<p><a href="https://mlr3.mlr-org.com/reference/resample.html" class="refcode"><code>resample()</code></a>, <a href="https://mlr3.mlr-org.com/reference/benchmark.html" class="refcode"><code>benchmark()</code></a>, and <a href="https://mlr3tuning.mlr-org.com/reference/tune.html" class="refcode"><code>tune()</code></a> work for this object just as for any other <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a>.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/pipeop-quickstart-graphlearner-2_2b23f29083ba4cb2c7beeb0ac73e4d55">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rr</span> <span class="op">=</span> <span class="fu">resample</span><span class="op">(</span><span class="fu">tsk</span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span>, <span class="va">graph_learner</span>, <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.ce 
     0.107 </code></pre>
</div>
</div>
</section><section id="sec-pipelines-pipeops" class="level2 page-columns page-full" data-number="7.2"><h2 data-number="7.2" class="anchored" data-anchor-id="sec-pipelines-pipeops">
<span class="header-section-number">7.2</span> <code>PipeOp</code>: Pipeline Operators</h2>
<p>The most fundamental unit of functionality within <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> is the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html" class="refcode"><code>PipeOp</code></a>, short for “pipeline operator”. It represents a transformative operation on input (for example, a training dataset), resulting in output. Like a learner, it possesses a <code>$train()</code> and a <code>$predict()</code> function; however, unlike a learner, the <code>$train()</code> function can also return a result. The training phase typically generates a particular model of the data, which is saved as internal state. The prediction phase then operates on the prediction data based on the trained model. Therefore, just like a learner, a PipeOp has “parameters” (i.e., the state) that are trained, but also “hyperparameters” that users can set. An illustration of this behavior is the <em>principal component analysis</em> operation (<a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_pca.html" class="refcode"><code>po("pca")</code></a>), which we have already seen in the previous section:</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/pipeop-intro-1_0ea89c77a747f6ccec1c7e1c96ef315a">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pca</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"pca"</span><span class="op">)</span></span>
<span><span class="va">pca</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PipeOp: &lt;pca&gt; (not trained)
values: &lt;list()&gt;
Input channels &lt;name [train type, predict type]&gt;:
  input [Task,Task]
Output channels &lt;name [train type, predict type]&gt;:
  output [Task,Task]</code></pre>
</div>
</div>
<p>When printed, various aspects of this PipeOp can be observed: The first line tells us the ID of the PipeOp (“<code>pca</code>”) and that it is not trained yet, therefore lacking a <code>$state</code>. The second line would tell us about hyperparameter values. However, this is an empty list here, as we are using the default settings of <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_pca.html" class="refcode"><code>po("pca")</code></a>. The remaining lines provide information about the input and output types of this PipeOp. The PCA PipeOp takes one input (named “<code>input</code>”) of type “<code>Task</code>”, both during training and prediction (thus “<code>[Task,Task]</code>). It produces one output (named”<code>output</code>“), also of type”<code>Task</code>” during both phases.</p>
<p>Training is conducted using the <code>$train()</code>-method. Unlike the learner’s <code>$train()</code> method, we can imagine the PipeOp’s <code>$train()</code> as potentially having multiple inputs and outputs. This is implemented through <code>list</code>s: Both the <code>$train()</code> input and output of a PipeOp are always <code>list</code>s; the number of elements of these lists depends on the operation. For example, the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_pca.html" class="refcode"><code>po("pca")</code></a> PipeOp only transforms a single dataset and is thus invoked with a list containing a single element, the training data task. It returns a modified task with features replaced by their principal components.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-003_f6911cfc919f39e3dd6ae9586b287c22">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">poin</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">tsk</span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">poout</span> <span class="op">=</span> <span class="va">pca</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">poin</span><span class="op">)</span></span>
<span><span class="va">poout</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$output
&lt;TaskClassif:iris&gt; (150 x 5): Iris Flowers
* Target: Species
* Properties: multiclass
* Features (4):
  - dbl (4): PC1, PC2, PC3, PC4</code></pre>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">poout</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">head</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species   PC1    PC2     PC3      PC4
1:  setosa -2.68  0.319 -0.0279 -0.00226
2:  setosa -2.71 -0.177 -0.2105 -0.09903
3:  setosa -2.89 -0.145  0.0179 -0.01997
4:  setosa -2.75 -0.318  0.0316  0.07558
5:  setosa -2.73  0.327  0.0901  0.06126
6:  setosa -2.28  0.741  0.1687  0.02420</code></pre>
</div>
</div>
<p>During training, the PCA transforms incoming data by rotating it in such a way that features become uncorrelated and are ordered by their contribution to total variance. The rotation matrix is also saved to be applied to new data during the “prediction phase”. This allows for “prediction” with single rows of new data, where a row’s scores on each of the principal components (the components of the <em>training</em> data!) are computed.</p>
<p>Similarly to <code>$train()</code>, the <code>$predict()</code> function operates on <code>list</code>s:</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-004_71e0fa5563c32cee8e26e893bc594965">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">single_line_iris</span> <span class="op">=</span> <span class="fu">tsk</span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">single_line_iris</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species Petal.Length Petal.Width Sepal.Length Sepal.Width
1:  setosa          1.4         0.2          5.1         3.5</code></pre>
</div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">poin</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">single_line_iris</span><span class="op">)</span></span>
<span><span class="va">poout</span> <span class="op">=</span> <span class="va">pca</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">poin</span><span class="op">)</span></span>
<span><span class="va">poout</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species   PC1   PC2     PC3      PC4
1:  setosa -2.68 0.319 -0.0279 -0.00226</code></pre>
</div>
</div>
<p>The internal state that is trained in the <code>$train()</code> call is stored in the <code>$state</code> field (shown in <a href="#fig-pipelines-state">Figure&nbsp;<span class="quarto-unresolved-ref">fig-pipelines-state</span></a>). It is analogous to the <code>$model</code> field of a learner, and its content depends on the class of PipeOp being used.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-005_3627488d127fa55322f0c42635f1296c">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pca</span><span class="op">$</span><span class="va">state</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Standard deviations (1, .., p=4):
[1] 2.056 0.493 0.280 0.154

Rotation (n x k) = (4 x 4):
                 PC1     PC2     PC3    PC4
Petal.Length  0.8567 -0.1734  0.0762  0.480
Petal.Width   0.3583 -0.0755  0.5458 -0.754
Sepal.Length  0.3614  0.6566 -0.5820 -0.315
Sepal.Width  -0.0845  0.7302  0.5979  0.320</code></pre>
</div>
</div>
<section id="creating-pipeops" class="level3 page-columns page-full" data-number="7.2.1"><h3 data-number="7.2.1" class="anchored" data-anchor-id="creating-pipeops">
<span class="header-section-number">7.2.1</span> Creating <code>PipeOp</code>s</h3>
<p>Each PipeOp is an instance of an <code>R6</code> class, with many classes provided by the <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> package itself. They can be retrieved from the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops.html" class="refcode"><code>mlr_pipeops</code></a> dictionary, most easily by using the <a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="refcode"><code>po()</code></a> convenience function. A shortcut for creating lists of PipeOps from a vector of names is <a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="refcode"><code>pos()</code></a>. When retrieving PipeOps from the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops.html" class="refcode"><code>mlr_pipeops</code></a> dictionary, it is also possible to provide additional constructor arguments, such as an ID or hyperparameter settings.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-2-009_46557f0069a69287135bb4853ea1104e">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"pca"</span>, rank. <span class="op">=</span> <span class="fl">3</span>, id <span class="op">=</span> <span class="st">"pca2"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PipeOp: &lt;pca2&gt; (not trained)
values: &lt;rank.=3&gt;
Input channels &lt;name [train type, predict type]&gt;:
  input [Task,Task]
Output channels &lt;name [train type, predict type]&gt;:
  output [Task,Task]</code></pre>
</div>
</div>
<p>Note how the printed output for this PipeOp differs from the one shown for <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_pca.html" class="refcode"><code>po("pca")</code></a> above: It has a different ID, and the fact that the <code>rank.</code> setting differs from the default is also shown.</p>
<p>Some PipeOps, in fact, require construction arguments, for example when they are operators that wrap another <code>mlr3</code>-object.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-pipeops-006_ac6ea946641ee4f6ee2ebc9cc8a3821f">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">po_learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner"</span>, learner <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="page-columns page-full"><p>Calling <code><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po()</a></code> by itself prints all available PipeOps. You can use <code>as.data.table(po())</code> to get a more detailed list with additional meta-data. The current list of all PipeOps contained in <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> with links to their documentation can also be found on the <a href="https://mlr-org.com/pipeops.html">mlr website</a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;<a href="https://mlr-org.com/pipeops.html">https://mlr-org.com/pipeops.html</a></p></li></div></div>
<div class="cell" data-hash="sequential_pipelines_cache/html/06-pipelines-pipeops-006-1_e2778d802414ad4fe297da7c9e942bb7">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;DictionaryPipeOp&gt; with 64 stored values
Keys: boxcox, branch, chunk, classbalancing, classifavg,
  classweights, colapply, collapsefactors, colroles, copy,
  datefeatures, encode, encodeimpact, encodelmer, featureunion,
  filter, fixfactors, histbin, ica, imputeconstant, imputehist,
  imputelearner, imputemean, imputemedian, imputemode,
  imputeoor, imputesample, kernelpca, learner, learner_cv,
  missind, modelmatrix, multiplicityexply, multiplicityimply,
  mutate, nmf, nop, ovrsplit, ovrunite, pca, proxy, quantilebin,
  randomprojection, randomresponse, regravg, removeconstants,
  renamecolumns, replicate, scale, scalemaxabs, scalerange,
  select, smote, spatialsign, subsample, targetinvert,
  targetmutate, targettrafoscalerange, textvectorizer,
  threshold, tunethreshold, unbranch, vtreat, yeojohnson</code></pre>
</div>
</div>
<div class="page-columns page-full"><p>In some cases where an operation is needed that is not provided by <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a>, it may be necessary to create custom PipeOps. The <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> package contains a vignette on how to do this, which can be accessed by running <code><a href="https://mlr3pipelines.mlr-org.com/articles/extending.html">vignette("extending", package = "mlr3pipelines")</a></code> in <code>R</code>, or <a href="https://mlr3pipelines.mlr-org.com/articles/extending.html">online</a><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p><div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;<a href="https://mlr3pipelines.mlr-org.com/articles/extending.html">https://mlr3pipelines.mlr-org.com/articles/extending.html</a></p></li></div></div>
</section></section><section id="sec-pipelines-graphs" class="level2" data-number="7.3"><h2 data-number="7.3" class="anchored" data-anchor-id="sec-pipelines-graphs">
<span class="header-section-number">7.3</span> <code>Graph</code>: Networks of <code>PipeOp</code>s</h2>
<section id="basics-building-a-graph" class="level3" data-number="7.3.1"><h3 data-number="7.3.1" class="anchored" data-anchor-id="basics-building-a-graph">
<span class="header-section-number">7.3.1</span> Basics: Building a <code>Graph</code>
</h3>
<p>PipeOps are used to represent individual computational steps in ML pipelines. These pipelines themselves are defined by <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="refcode"><code>Graph</code></a> objects. A Graph is a collection of PipeOps with “edges” that guide the flow of data.</p>
<p>The most convenient way of building a Graph is to connect a sequence of PipeOps using the <strong><a href="https://mlr3pipelines.mlr-org.com/reference/%%3E%3E%.html" class="refcode"><code>%&gt;&gt;%</code></a></strong> (“double-arrow”) operator. When given two PipeOps, this operator creates a Graph that first executes the left-hand PipeOp, followed by the right-hand one. It can also be used to connect a Graph with a PipeOp, or with another Graph. The following example creates a Graph that first adds a <code>Petal.Area</code> feature to a given dataset, and then performs scaling and centering of all numeric features.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-sequential-01_760f75a295eea269de9b1dcef6028f95">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">po_area</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"mutate"</span>,</span>
<span>  mutation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Petal.Area <span class="op">=</span> <span class="op">~</span><span class="va">Petal.Width</span> <span class="op">*</span> <span class="va">Petal.Length</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">po_scale</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"scale"</span><span class="op">)</span></span>
<span><span class="va">gr</span> <span class="op">=</span> <span class="va">po_area</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="va">po_scale</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Graph with 2 PipeOps:
     ID         State sccssors prdcssors
 mutate &lt;&lt;UNTRAINED&gt;&gt;    scale          
  scale &lt;&lt;UNTRAINED&gt;&gt;             mutate</code></pre>
</div>
</div>
<p>The printer provides information about the layout of the Graph: For each PipOp (column “ID”), it displays information about its state, as well as a list of its successors (“sccssors”, i.e.&nbsp;which PipeOps are connected to its output and come directly after it) and its predecessors (“prdcssors”, which PipeOps are connected to its input). For this simple Graph, we see that the output of the PipeOp with the ID “<code>mutate</code>” is given to the one with ID “<code>scale</code>”. While the printer of a Graph gives some information about its layout, the most intuitive way of visualizing it is using the <code>$plot()</code> function.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-017_ad6c23a2defd5b952d4ebacec6945648">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gr</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>horizontal <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="sequential_pipelines_files/figure-html/05-pipelines-in-depth-017-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="graphs-are-nodes-with-edges" class="level3" data-number="7.3.2"><h3 data-number="7.3.2" class="anchored" data-anchor-id="graphs-are-nodes-with-edges">
<span class="header-section-number">7.3.2</span> <code>Graph</code>s are Nodes with Edges</h3>
<p>Internally, Graphs are collections of PipeOps with edges connecting them. The collection of PipeOps inside a Graph can be accessed through the <code>$pipeops</code> field. The set of edges in the Graph can be examined through the <code>$edges</code> field. It is a <code>data.table</code> listing the “source” (<code>src_id</code>, <code>src_channel</code>) and “destination” (<code>dst_id</code>, <code>dst_channel</code>) of data flowing along each edge.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-018-2_0c398f7cecf16675b5bdd8c2f8ab0edc">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gr</span><span class="op">$</span><span class="va">pipeops</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$mutate
PipeOp: &lt;mutate&gt; (not trained)
values: &lt;mutation=&lt;list&gt;, delete_originals=FALSE&gt;
Input channels &lt;name [train type, predict type]&gt;:
  input [Task,Task]
Output channels &lt;name [train type, predict type]&gt;:
  output [Task,Task]

$scale
PipeOp: &lt;scale&gt; (not trained)
values: &lt;robust=FALSE&gt;
Input channels &lt;name [train type, predict type]&gt;:
  input [Task,Task]
Output channels &lt;name [train type, predict type]&gt;:
  output [Task,Task]</code></pre>
</div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gr</span><span class="op">$</span><span class="va">edges</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   src_id src_channel dst_id dst_channel
1: mutate      output  scale       input</code></pre>
</div>
</div>
<p>Besides using the <a href="https://mlr3pipelines.mlr-org.com/reference/%%3E%3E%.html" class="refcode"><code>%&gt;&gt;%</code></a>-operator to create Graphs, it is also possible to create them explicitly. A Graph is empty when first created, and PipeOps can be added using the <code>$add_pipeop()</code> method. The <code>$add_edge()</code> method is used to create connections between them. The above Graph can therefore also be created in the following way:</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-016_c8773991f21a64d5100c709effa3decb">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">po_area</span><span class="op">)</span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">po_scale</span><span class="op">)</span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="fu">add_edge</span><span class="op">(</span><span class="st">"mutate"</span>, <span class="st">"scale"</span><span class="op">)</span>  <span class="co"># address by PipeOp-ID</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Although it is also possible to modify individual PipeOps and edges in a Graph through the <code>$pipeops</code> and <code>$edges</code> fields, this is not recommended, as no error checking is performed and it may put the Graph in an invalid state. Only do this if you know what you are doing.</p>
</div>
</div>
</section><section id="using-a-graph" class="level3" data-number="7.3.3"><h3 data-number="7.3.3" class="anchored" data-anchor-id="using-a-graph">
<span class="header-section-number">7.3.3</span> Using a <code>Graph</code>
</h3>
<p>A Graph itself has a <code>$train()</code> and a <code>$predict()</code> method that accept some data and propagate this data through the network of PipeOps, by calling their respective <code>$train()</code> and <code>$predict()</code> methods. The return value is the output of the PipeOp(s) without outgoing edges. Just like for PipeOps, the output is a list.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-019_d85f997827dbfec840da6dd1df2df761">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">result</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu">tsk</span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$scale.output
&lt;TaskClassif:iris&gt; (150 x 6): Iris Flowers
* Target: Species
* Properties: multiclass
* Features (5):
  - dbl (5): Petal.Area, Petal.Length, Petal.Width,
    Sepal.Length, Sepal.Width</code></pre>
</div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">head</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species Petal.Area Petal.Length Petal.Width Sepal.Length Sepal.Width
1:  setosa      -1.17        -1.34       -1.31       -0.898      1.0156
2:  setosa      -1.17        -1.34       -1.31       -1.139     -0.1315
3:  setosa      -1.17        -1.39       -1.31       -1.381      0.3273
4:  setosa      -1.17        -1.28       -1.31       -1.501      0.0979
5:  setosa      -1.17        -1.34       -1.31       -1.018      1.2450
6:  setosa      -1.09        -1.17       -1.05       -0.535      1.9333</code></pre>
</div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">result</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">single_line_iris</span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">head</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species Petal.Area Petal.Length Petal.Width Sepal.Length Sepal.Width
1:  setosa      -1.17        -1.34       -1.31       -0.898        1.02</code></pre>
</div>
</div>
</section><section id="debugging-a-graph-with-intermediate-results" class="level3" data-number="7.3.4"><h3 data-number="7.3.4" class="anchored" data-anchor-id="debugging-a-graph-with-intermediate-results">
<span class="header-section-number">7.3.4</span> Debugging a <code>Graph</code> with Intermediate Results</h3>
<p>When Graphs are evaluated, they do not keep intermediate results for memory efficiency, unless the <code>$keep_results</code> flag is set first. Inspecting these results may help understanding the inner workings of Graphs, in particular when they produce unexpected results.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-021-x_2d0d70f83f0c5d06d68c654a43c13981">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gr</span><span class="op">$</span><span class="va">keep_results</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="va">result</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">single_line_iris</span><span class="op">)</span></span>
<span><span class="va">intermediate</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">mutate</span><span class="op">$</span><span class="va">.result</span></span>
<span><span class="va">intermediate</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$output
&lt;TaskClassif:iris&gt; (1 x 6): Iris Flowers
* Target: Species
* Properties: multiclass
* Features (5):
  - dbl (5): Petal.Area, Petal.Length, Petal.Width,
    Sepal.Length, Sepal.Width</code></pre>
</div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">intermediate</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species Petal.Length Petal.Width Sepal.Length Sepal.Width Petal.Area
1:  setosa          1.4         0.2          5.1         3.5       0.28</code></pre>
</div>
</div>
</section></section><section id="sec-pipelines-sequential" class="level2" data-number="7.4"><h2 data-number="7.4" class="anchored" data-anchor-id="sec-pipelines-sequential">
<span class="header-section-number">7.4</span> Sequential <code>Learner</code>-Pipelines</h2>
<p>Possibly the most common application for <a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a> is to use it to perform basic preprocessing tasks, such as missing value imputation or factor encoding, and to then feed the resulting data into a <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a>. A Graph representing this workflow manipulates data and fits a <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a>-model during training, and uses the fitted model with data that has been similarly preprocessed during prediction. Conceptually, the process may look as shown in <a href="#fig-pipelines-pipeline">Figure&nbsp;<span class="quarto-unresolved-ref">fig-pipelines-pipeline</span></a>.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/fig-pipelines-pipeline_f6dc66e11051eea74530568857296084">
<div class="cell-output-display">
<div id="fig-pipelines-pipeline" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="Figures/pipe_action.svg" class="img-fluid figure-img" alt="Traning data is transformed by a sequential pipeline during training, being passed along a scaling, factor encoding, and median imputation PipeOp and finally given to a learner. Prediction data is passed along the same pipeline, this time containing state and model objects, to create a prediction."></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;7.3: Conceptualization of training and prediction process inside a sequential learner-pipeline. During training (top row), the data is passed along the preprocessing operators, each of which modifies the data and creates a <code>$state</code>. Finally, the learner receives the data and a model is created. During prediction (bottom row), data is likewise transformed by preprocessing operators, using their respective <code>$state</code> information in the process. The learner then receives data that has the same format as the data seen during training, and makes a prediction.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>While a <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a> is not a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html" class="refcode"><code>PipeOp</code></a> by itself, it can be readily converted into one using <a href="https://mlr3pipelines.mlr-org.com/reference/as_pipeop.html" class="refcode"><code>as_pipeop()</code></a>, or alternatively <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner.html" class="refcode"><code>po("learner")</code></a>, which creates a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner.html" class="refcode"><code>PipeOpLearner</code></a>-wrapper-class.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-modeling-0_0f9389ce737fc5166ae45b9d670e23f8">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">learner_rpart</span> <span class="op">=</span> <span class="fu">lrn</span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span></span>
<span><span class="va">po_rpart</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/as_pipeop.html">as_pipeop</a></span><span class="op">(</span><span class="va">learner_rpart</span><span class="op">)</span></span>
<span><span class="va">po_rpart</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner"</span>, <span class="va">learner_rpart</span><span class="op">)</span>  <span class="co"># yields the same result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, this conversion is rarely necessary, as the <code>%&gt;&gt;%</code>-operator automatically converts learners to PipeOps. The following code creates a Graph that adds a <code>Petal.Area</code> feature, followed by fitting a <code>"classif.rpart"</code> decision tree model.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-modeling-1_ed8c078e52a07a74ac5a754d3cead9ad">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">po_area</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"mutate"</span>,</span>
<span>  mutation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Petal.Area <span class="op">=</span> <span class="op">~</span><span class="va">Petal.Width</span> <span class="op">*</span> <span class="va">Petal.Length</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">gr</span> <span class="op">=</span> <span class="va">po_area</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="va">learner_rpart</span>  <span class="co"># could just as well use po_rpart</span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span>horizontal <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="sequential_pipelines_files/figure-html/05-pipelines-modeling-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>To use a Graph as a learner within <a href="https://mlr3.mlr-org.com"><code>mlr3</code></a>, it is necessary to wrap it in a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html" class="refcode"><code>GraphLearner</code></a> object. This is because there are various differences between the classes, most notably the return values of the <code>$train()</code> and <code>$predict()</code> methods. A Graph can be converted to a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html" class="refcode"><code>GraphLearner</code></a> using <a href="https://mlr3.mlr-org.com/reference/as_learner.html" class="refcode"><code>as_learner()</code></a>.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-modeling-2_5021db8695bdd0819eb07b9d795b5a5b">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">graph_learner</span> <span class="op">=</span> <span class="fu">as_learner</span><span class="op">(</span><span class="va">gr</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This learner can be used like any other <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a>. In particular it can be used with <code>resample()</code> and <code>benchmark()</code>. Let us compare our sequential pipeline with the <code>"classif.rpart"</code>-<code>Learner</code> by itself:</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-modeling-3_bdd44b06ec1a01899592d4030c4085f7">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">grid</span> <span class="op">=</span> <span class="fu">benchmark_grid</span><span class="op">(</span></span>
<span>  <span class="fu">tsks</span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">graph_learner</span>, <span class="va">learner_rpart</span><span class="op">)</span>,</span>
<span>  <span class="fu">rsmps</span><span class="op">(</span><span class="st">"repeated_cv"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">bmr</span> <span class="op">=</span> <span class="fu">benchmark</span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span><span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr task_id           learner_id resampling_id iters classif.ce
1:  1    iris mutate.classif.rpart   repeated_cv   100     0.0387
2:  2    iris        classif.rpart   repeated_cv   100     0.0667
Hidden columns: resample_result</code></pre>
</div>
</div>
<section id="accessing-pipeline-objects" class="level3" data-number="7.4.1"><h3 data-number="7.4.1" class="anchored" data-anchor-id="accessing-pipeline-objects">
<span class="header-section-number">7.4.1</span> Accessing Pipeline Objects</h3>
<p>The <code>graph_learner</code> variable containing the <code>GraphLearner</code> object can be used as an ordinary learner. However, it is in fact a wrapper around a Graph, which in turn contains PipeOps, which themselves encompass different components. The following steps demonstrate how to analyze the flow of data in a <code>GraphLearner</code>. First, the <code>$keep_results</code> flag needs to be set, so intermediate results are retained.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-modeling-debugging_004dbcfbe5f0bb9c8e38664c6dea828c">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">graph_learner</span><span class="op">$</span><span class="va">graph_model</span><span class="op">$</span><span class="va">keep_results</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="va">graph_learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu">tsk</span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The Graph can be accessed through the <code>$graph_model</code> field. Using this field, one can now investigate the data fed to the <code>"classif.rpart"</code> learner by examining the output of the <code>"mutate"</code>-PipeOp. As expected, it includes the additional feature <code>Petal.Area</code>.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-modeling-debugging-1_16a89cbc842ac5c62dd8d9a858f6c046">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mutate_result</span> <span class="op">=</span> <span class="va">graph_learner</span><span class="op">$</span><span class="va">graph_model</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">mutate</span><span class="op">$</span><span class="va">.result</span></span>
<span><span class="va">mutate_result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$output
&lt;TaskClassif:iris&gt; (150 x 6): Iris Flowers
* Target: Species
* Properties: multiclass
* Features (5):
  - dbl (5): Petal.Area, Petal.Length, Petal.Width,
    Sepal.Length, Sepal.Width</code></pre>
</div>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mutate_result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">head</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Species Petal.Length Petal.Width Sepal.Length Sepal.Width Petal.Area
1:  setosa          1.4         0.2          5.1         3.5       0.28
2:  setosa          1.4         0.2          4.9         3.0       0.28
3:  setosa          1.3         0.2          4.7         3.2       0.26
4:  setosa          1.5         0.2          4.6         3.1       0.30
5:  setosa          1.4         0.2          5.0         3.6       0.28
6:  setosa          1.7         0.4          5.4         3.9       0.68</code></pre>
</div>
</div>
<p>One can also look at the <code>$state</code> of the various PipeOps to investigate the trained model. Here the trained <a href="https://mlr3.mlr-org.com/reference/mlr_learners_classif.rpart.html" class="refcode"><code>lrn("classif.rpart")</code></a> classification tree is interesting. However, it is wrapped inside a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner.html" class="refcode"><code>PipeOpLearner</code></a>: The trained <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a> object has to be extracted before inspection.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-modeling-debugging-2_b4c12df402e2c9269618e13012117e14">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">trained_p_rpart</span> <span class="op">=</span> <span class="va">graph_learner</span><span class="op">$</span><span class="va">graph_model</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">classif.rpart</span></span>
<span><span class="va">trained_l_rpart</span> <span class="op">=</span> <span class="va">trained_p_rpart</span><span class="op">$</span><span class="va">learner_model</span></span>
<span><span class="va">trained_l_rpart</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;LearnerClassifRpart:classif.rpart&gt;: Classification Tree
* Model: rpart
* Parameters: xval=0
* Packages: mlr3, rpart
* Predict Types:  [response], prob
* Feature Types: logical, integer, numeric, factor, ordered
* Properties: importance, missings, multiclass,
  selected_features, twoclass, weights</code></pre>
</div>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">trained_l_rpart</span><span class="op">$</span><span class="va">model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 150 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

1) root 150 100 setosa (0.3333 0.3333 0.3333)  
  2) Petal.Length&lt; 2.45 50   0 setosa (1.0000 0.0000 0.0000) *
  3) Petal.Length&gt;=2.45 100  50 versicolor (0.0000 0.5000 0.5000)  
    6) Petal.Area&lt; 7.43 46   0 versicolor (0.0000 1.0000 0.0000) *
    7) Petal.Area&gt;=7.43 54   4 virginica (0.0000 0.0741 0.9259) *</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>A more straightforward approach to access the learner at the end of a Graph in a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html" class="refcode"><code>GraphLearner</code></a> is to use the <code>$base_learner()</code> method. One can therefore also use <code>graph_learner$base_learner()$model</code> to access the trained model. However, this method does not work for ensembling <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html" class="refcode"><code>GraphLearner</code></a> objects containing multiple learners.</p>
</div>
</div>
</section><section id="sec-pipelines-hyperparameters" class="level3" data-number="7.4.2"><h3 data-number="7.4.2" class="anchored" data-anchor-id="sec-pipelines-hyperparameters">
<span class="header-section-number">7.4.2</span> Pipeline Hyperparameters</h3>
<p>Much like <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a>s, PipeOps have <em>hyperparameters</em>, provided by the <span class="refpkg"><a href="https://paradox.mlr-org.com"><code>paradox</code></a></span> package. These can be accessed through the <code>$param_set</code> field, providing information about the adjustable hyperparameters.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-032_731ff0ff9af1b1d2e28038c8803854aa">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">po_pca</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"pca"</span><span class="op">)</span></span>
<span><span class="va">po_pca</span><span class="op">$</span><span class="va">param_set</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSet:pca&gt;
               id    class lower upper nlevels       default value
1:         center ParamLgl    NA    NA       2          TRUE      
2:         scale. ParamLgl    NA    NA       2         FALSE      
3:          rank. ParamInt     1   Inf     Inf                    
4: affect_columns ParamUty    NA    NA     Inf &lt;Selector[1]&gt;      </code></pre>
</div>
</div>
<p>Similar to <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a> objects, the <code>$param_set$values</code> field can be used to alter hyperparameter settings; alternatively, hyperparameter values can be set using the <code>$param_set$set_values()</code> function or during construction.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-033_9ef302df38f5bd386479b0af9c72d1ee">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">po_pca</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">center</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="co"># More convenient when multiple hyperparameters need to be set:</span></span>
<span><span class="va">po_pca</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="fu">set_values</span><span class="op">(</span>center <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Alternatively:</span></span>
<span><span class="va">po_pca</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"pca"</span>, center <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># All of these have the same result:</span></span>
<span><span class="va">po_pca</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$center
[1] FALSE</code></pre>
</div>
</div>
<p>Each PipeOp can have its own individual hyperparameters, which are collected together in the Graph’s <code>$param_set</code>. A PipeOp’s parameter names are prefixed with its ID to avoid parameter name clashes.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-035_d3de91679065f7171f1e44191150b9d8">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gr</span> <span class="op">=</span> <span class="va">po_pca</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"scale"</span>, center <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">gr</span><span class="op">$</span><span class="va">param_set</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ParamSetCollection&gt;
                     id    class lower upper nlevels        default
1:           pca.center ParamLgl    NA    NA       2           TRUE
2:           pca.scale. ParamLgl    NA    NA       2          FALSE
3:            pca.rank. ParamInt     1   Inf     Inf               
4:   pca.affect_columns ParamUty    NA    NA     Inf  &lt;Selector[1]&gt;
5:         scale.center ParamLgl    NA    NA       2           TRUE
6:          scale.scale ParamLgl    NA    NA       2           TRUE
7:         scale.robust ParamLgl    NA    NA       2 &lt;NoDefault[3]&gt;
8: scale.affect_columns ParamUty    NA    NA     Inf  &lt;Selector[1]&gt;
1 variable not shown: [value]</code></pre>
</div>
</div>
<p>The hyperparameter settings of a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html" class="refcode"><code>GraphLearner</code></a> can be changed directly (recommended), but they can also be accessed indirectly by reading (and modifying) the underlying Graph’s, PipeOp’s, or learner’s hyperparameters.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>When a learner is encapsulated in a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_learner.html" class="refcode"><code>PipeOpLearner</code></a> through <code><a href="https://mlr3pipelines.mlr-org.com/reference/as_pipeop.html">as_pipeop()</a></code>, its <code>ParamSet</code> is exposed. Once this PipeOp becomes part of a Graph, the hyperparameters are prefixed with the PipeOp’s ID, which by default is the learner’s ID. When a Graph is converted back into a learner using <code>as_learner()</code>, the resulting <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html" class="refcode"><code>GraphLearner</code></a> retains the Graph’s <a href="https://paradox.mlr-org.com/reference/ParamSet.html" class="refcode"><code>ParamSet</code></a>. Therefore the original learner’s hyperparameters are now prefixed with the learner’s ID. For example, if a <a href="https://mlr3.mlr-org.com/reference/mlr_learners_classif.rpart.html" class="refcode"><code>lrn("classif.rpart")</code></a> is encapsulated in a Graph, its <code>maxdepth</code> hyperparameter becomes <code>classif.rpart.maxdepth</code>.</p>
</div>
</div>
</section><section id="ids-and-name-clashes" class="level3" data-number="7.4.3"><h3 data-number="7.4.3" class="anchored" data-anchor-id="ids-and-name-clashes">
<span class="header-section-number">7.4.3</span> IDs and Name Clashes</h3>
<p>To ensure that PipeOps can be accessed by their ID within Graphs, their IDs within a Graph must be unique. IDs can be set during construction using the <code>id</code> argument of <code><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po()</a></code>, or they can be modified for existing PipeOps. For PipeOps already in a Graph, the <code>$set_names()</code> method can also be employed to change IDs, although this should rarely be necessary.</p>
<div class="cell" data-hash="sequential_pipelines_cache/html/05-pipelines-in-depth-040_594aeafeb444e1968ba7d673e3248a4a">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Without the `id` argument, this would lead to a name collision error</span></span>
<span><span class="va">gr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"pca"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com/reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com/reference/po.html">po</a></span><span class="op">(</span><span class="st">"pca"</span>, id <span class="op">=</span> <span class="st">"pca2"</span><span class="op">)</span></span>
<span><span class="va">gr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Graph with 2 PipeOps:
   ID         State sccssors prdcssors
  pca &lt;&lt;UNTRAINED&gt;&gt;     pca2          
 pca2 &lt;&lt;UNTRAINED&gt;&gt;                pca</code></pre>
</div>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gr</span><span class="op">$</span><span class="fu">set_names</span><span class="op">(</span></span>
<span>  old <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pca"</span>, <span class="st">"pca2"</span><span class="op">)</span>,</span>
<span>  new <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pca_1"</span>, <span class="st">"pca_2"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">gr</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Graph with 2 PipeOps:
    ID         State sccssors prdcssors
 pca_1 &lt;&lt;UNTRAINED&gt;&gt;    pca_2          
 pca_2 &lt;&lt;UNTRAINED&gt;&gt;              pca_1</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Avoid changing the ID of a PipeOp that is already in a Graph through <code>graph$pipeops$&lt;old_id&gt;$id = &lt;new_id&gt;</code>, as this will only alter the PipeOp’s record of its own ID, not the Graph’s record. This would result in undefined behavior for the Graph.</p>
</div>
</div>
</section></section><section id="recap" class="level2" data-number="7.5"><h2 data-number="7.5" class="anchored" data-anchor-id="recap">
<span class="header-section-number">7.5</span> Recap</h2>
<p><span class="refpkg"><a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a></span> provides <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html" class="refcode"><code>PipeOp</code></a> objects that provide preprocessing, postprocessing, and ensembling operations that can be created using the <a href="https://mlr3pipelines.mlr-org.com/reference/po.html" class="refcode"><code>po()</code></a> constructor function. PipeOps have an ID and hyperparameters that can be set during construction and can be modified later.</p>
<p>PipeOps are concatenated using the <a href="https://mlr3pipelines.mlr-org.com/reference/%%3E%3E%.html" class="refcode"><code>%&gt;&gt;%</code></a>-operator to form <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html" class="refcode"><code>Graph</code></a> objects. Graphs can be converted to <a href="https://mlr3.mlr-org.com/reference/Learner.html" class="refcode"><code>Learner</code></a> objects using the <a href="https://mlr3.mlr-org.com/reference/as_learner.html" class="refcode"><code>as_learner</code></a> function, after which they can be benchmarked and tuned using the tools provided by <span class="refpkg"><a href="https://mlr3.mlr-org.com"><code>mlr3</code></a></span>. Various standard Graphs are provided by the <a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html" class="refcode"><code>ppl()</code></a> constructor function.</p>
</section><section id="exercises" class="level2" data-number="7.6"><h2 data-number="7.6" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">7.6</span> Exercises</h2>
<ol type="1">
<li>Create a learner containing a Graph that first imputes missing values using <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_imputeoor.html" class="refcode"><code>po("imputeoor")</code></a>, standardizes the data using <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html" class="refcode"><code>po("scale")</code></a>, and then fits a logistic linear model using <a href="https://mlr3learners.mlr-org.com/reference/mlr_learners_classif.log_reg.html" class="refcode"><code>lrn("classif.log_reg")</code></a>.</li>
<li>Train the Graph created in the previous exercise on the <a href="https://mlr3.mlr-org.com/reference/mlr_tasks_pima.html" class="refcode"><code>tsk("pima")</code></a> task and display the coefficients of the resulting model. What are two different ways to access the model?</li>
<li>Verify that the “<code>age</code>” column of the input task of <a href="https://mlr3learners.mlr-org.com/reference/mlr_learners_classif.log_reg.html" class="refcode"><code>lrn("classif.log_reg")</code></a> from the previous exercise is indeed standardized. One way to do this would be to look at the <code>$data</code> field of the <a href="https://mlr3learners.mlr-org.com/reference/mlr_learners_classif.log_reg.html" class="refcode"><code>lrn("classif.log_reg")</code></a> model; however, that is specific to that particular learner and does not work in general. What would be a different, more general way to do this? Hint: use the <code>$keep_results</code> flag.</li>
<li>Consider the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_select.html" class="refcode"><code>po("select")</code></a> in <a href="#sec-pipelines-stack"><span class="quarto-unresolved-ref">sec-pipelines-stack</span></a> that is used to only keep the columns ending in “<code>M</code>”. If the classification task had more than two classes, it would be more appropriate to list the single class we <em>do not</em> want to keep, instead of listing all the classes we do want to keep. How would you do this, using the <a href="https://mlr3pipelines.mlr-org.com/reference/Selector.html" class="refcode"><code>Selector</code></a> functions provided by <span class="refpkg"><a href="https://mlr3pipelines.mlr-org.com"><code>mlr3pipelines</code></a></span>? (Note: The <a href="https://mlr3learners.mlr-org.com/reference/mlr_learners_classif.log_reg.html" class="refcode"><code>lrn("classif.log_reg")</code></a> learner used in <a href="#sec-pipelines-stack"><span class="quarto-unresolved-ref">sec-pipelines-stack</span></a> cannot handle more than two classes. To build the entire stack, you will need to use a different learner, such as <a href="https://mlr3learners.mlr-org.com/reference/mlr_learners_classif.multinom.html" class="refcode"><code>lrn("classif.multinom")</code></a>.)</li>
<li>How would you solve the previous exercise without even explicitly naming the class you want to exclude, so that your Graph works for any classification task? Hint: look at the <code>selector_subsample</code> in <a href="#sec-pipelines-bagging"><span class="quarto-unresolved-ref">sec-pipelines-bagging</span></a>.</li>
<li>Use the <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_imputelearner.html" class="refcode"><code>po("imputelearner")</code></a> PipeOp to impute missing values in the <a href="https://mlr3.mlr-org.com/reference/mlr_tasks_penguins.html" class="refcode"><code>tsk("penguins")</code></a> task using learners based on <a href="https://www.rdocumentation.org/packages/ranger/topics/ranger" class="refcode"><code>ranger::ranger</code></a>. Hint 1: you will need to use <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_imputelearner.html" class="refcode"><code>po("imputelearner")</code></a> twice, once for numeric features with <a href="https://mlr3learners.mlr-org.com/reference/mlr_learners_regr.ranger.html" class="refcode"><code>lrn("regr.ranger")</code></a>, and once for categorical features with <a href="https://mlr3learners.mlr-org.com/reference/mlr_learners_classif.ranger.html" class="refcode"><code>lrn("classif.ranger")</code></a>. Using the <code>affect_columns</code> argument of <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_imputelearner.html" class="refcode"><code>po("imputelearner")</code></a> will help you here. Hint 2: <a href="https://www.rdocumentation.org/packages/ranger/topics/ranger" class="refcode"><code>ranger::ranger</code></a> itself does not support missing values, but it is trained on all the features of <a href="https://mlr3.mlr-org.com/reference/mlr_tasks_penguins.html" class="refcode"><code>tsk("penguins")</code></a> that it is not currently imputing, some of which will also contain missings. A simple way to avoid problems here is to use <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_graphs_robustify.html" class="refcode"><code>ppl("robustify")</code></a> <em>inside</em> <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_imputelearner.html" class="refcode"><code>po("imputelearner")</code></a> next to the <a href="https://www.rdocumentation.org/packages/ranger/topics/ranger" class="refcode"><code>ranger::ranger</code></a> learner.</li>
</ol></section><section id="citation" class="level2" data-number="7.7"><h2 data-number="7.7" class="anchored" data-anchor-id="citation">
<span class="header-section-number">7.7</span> Citation</h2>
<p>Please cite this chapter as:</p>
<p>Binder M, Pfisterer F. (2024). Sequential Pipelines. In Bischl B, Sonabend R, Kotthoff L, Lang M, (Eds.), <em>Applied Machine Learning Using mlr3 in R</em>. CRC Press. https://mlr3book.mlr-org.com/sequential_pipelines.html.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-mlr3pipelines" class="csl-entry" role="listitem">
Binder, Martin, Florian Pfisterer, Michel Lang, Lennart Schneider, Lars Kotthoff, and Bernd Bischl. 2021. <span>“<span class="nocase">mlr3pipelines</span> - Flexible Machine Learning Pipelines in <span>R</span>.”</span> <em>Journal of Machine Learning Research</em> 22 (184): 1–7. <a href="http://jmlr.org/papers/v22/21-0281.html">http://jmlr.org/papers/v22/21-0281.html</a>.
</div>
<div id="ref-Thornton2013" class="csl-entry" role="listitem">
Thornton, Chris, Frank Hutter, Holger H. Hoos, and Kevin Leyton-Brown. 2013. <span>“Auto-<span>WEKA</span>.”</span> In <em>Proceedings of the 19th <span>ACM</span> <span>SIGKDD</span> International Conference on Knowledge Discovery and Data Mining</em>. <span>ACM</span>. <a href="https://doi.org/10.1145/2487575.2487629">https://doi.org/10.1145/2487575.2487629</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../../chapters/chapter6/feature_selection.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Feature Selection</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../chapters/chapter8/non-sequential_pipelines_and_tuning.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Non-sequential Pipelines and Tuning</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb68" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Sequential Pipelines {#sec-pipelines}</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>{{&lt; include ../../common/_setup.qmd &gt;}}</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="in">`r chapter = "Sequential Pipelines"`</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="in">`r authors(chapter)`</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipelines-setup, include = FALSE, cache = FALSE}</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3pipelines"</span>)</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">warnPartialMatchArgs =</span> <span class="cn">FALSE</span>)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">warnPartialMatchAttr =</span> <span class="cn">FALSE</span>)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">warnPartialMatchDollar =</span> <span class="cn">FALSE</span>)</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mlr3.exec_chunk_size =</span> <span class="dv">1</span>)</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">width =</span> <span class="dv">73</span>, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">fig.width =</span> <span class="dv">7</span>, <span class="at">fig.height =</span> <span class="dv">5</span>)</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3oml"</span>)</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"book"</span>, <span class="st">"openml"</span>), <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mlr3oml.cache =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"book"</span>, <span class="st">"openml"</span>, <span class="st">"cache"</span>))</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>Machine learning (ML) toolkits often try to abstract away the processes inside ML algorithms.</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>These toolkits provide a layer of abstraction, allowing users to swap one algorithm for another without having to worry about specifics of each algorithm.</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>The benefit of using <span class="in">`r ref_pkg("mlr3")`</span>, for example, is that one can use any <span class="in">`r ref("Learner")`</span>, <span class="in">`r ref("Task")`</span>, or <span class="in">`r ref("Resampling")`</span> object and use them for typical ML operations, mostly independently of what algorithms or datasets they represent.</span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>In the following code snippet, it would be trivial to swap in a different learner than <span class="in">`r ref("LearnerRegrRpart", "lrn(\"regr.rpart\")")`</span> without having to worry about implementation details:</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-002, output = FALSE}</span></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">as_task_regr</span>(cars, <span class="at">target =</span> <span class="st">"dist"</span>)</span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>learner_rpart <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"regr.rpart"</span>)</span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>resampling <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"holdout"</span>)</span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a><span class="fu">resample</span>(task, learner_rpart, resampling)</span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>However, this modularity breaks down as soon as the learning process encompasses more than just model fitting, like data preprocessing, building ensemble-models or even more complicated meta-models.</span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>This is where <span class="in">`r ref_pkg("mlr3pipelines")`</span> <span class="co">[</span><span class="ot">@mlr3pipelines</span><span class="co">]</span> steps in: it takes modularity one step further than <span class="in">`r mlr3`</span> and makes it possible to build individual steps within a <span class="in">`r ref("Learner")`</span> out of building blocks that manipulate data.</span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>Individual, frequently encountered building blocks, such as missing value imputation or majority vote ensembling, are provided as an (R6-)object, which we call a <span class="in">`r define("PipeOp")`</span>.</span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>These PipeOps can be connected using directed edges inside a <span class="in">`r define("Graph")`</span> (or "Pipeline") to represent the flow of data between operations.</span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>The <span class="in">`r ref("Graph")`</span> class represents an object similar to a directed acyclic graph (DAG), since the input of a PipeOp can not depend on its output and hence cycles are not allowed.</span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>However, the resemblance to a DAG is not perfect, since the <span class="in">`r ref("Graph")`</span> class allows for multiple edges between nodes.</span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>A term such as "directed acyclic multigraph" would be more accurate, but we will stick to the term "Graph" for simplicity.</span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a>Some examples of operations that can be performed with <span class="in">`r mlr3pipelines`</span> are:</span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Data manipulation and preprocessing operations, e.g. PCA, feature filtering, missing value imputation.</span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Task subsampling for speed or for handling of imbalanced classes.</span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Ensemble methods and aggregation of predictions.</span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Simultaneous model selection and hyperparameter tuning of both learners and preprocessing operators, by using <span class="in">`r mlr3tuning`</span>. This is sometimes facetiously referred to as "CASH", standing for "Combined Algorithm Selection and Hyperparameter optimization" <span class="co">[</span><span class="ot">@Thornton2013</span><span class="co">]</span>.</span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a>During model training, the PipeOps in a Graph operate on a given dataset and transform it.</span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a>PipeOps that come later in a Graph get the already transformed data as input.</span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true" tabindex="-1"></a>The Graph can therefore be thought of as a network representing function composition.</span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true" tabindex="-1"></a>However, besides transforming data, PipeOps also generate a *state*, similar to how learners train model parameters.</span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true" tabindex="-1"></a>This state is used to inform the PipeOp's operation during prediction.</span>
<span id="cb68-60"><a href="#cb68-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-61"><a href="#cb68-61" aria-hidden="true" tabindex="-1"></a>As a simple example, consider scaling features to have unit variance <span class="in">`po("scale", center = FALSE)`</span> (@fig-pipelines-state).</span>
<span id="cb68-62"><a href="#cb68-62" aria-hidden="true" tabindex="-1"></a>During training, it calculates and divides by the standard deviation of each feature.</span>
<span id="cb68-63"><a href="#cb68-63" aria-hidden="true" tabindex="-1"></a>For prediction, it would be wrong to divide by the standard deviation of the *prediction* dataset; instead the same scaling factors as during training should be used.</span>
<span id="cb68-64"><a href="#cb68-64" aria-hidden="true" tabindex="-1"></a>The PipeOp therefore stores the scaling factors of each feature in its state, to be used during prediction.</span>
<span id="cb68-65"><a href="#cb68-65" aria-hidden="true" tabindex="-1"></a>Each PipeOp stores its own state independently of other PipeOps.</span>
<span id="cb68-66"><a href="#cb68-66" aria-hidden="true" tabindex="-1"></a>A very simple sequential Graph that does various preprocessing operations before fitting a learner is displayed in @fig-pipelines-example&nbsp;(a).</span>
<span id="cb68-67"><a href="#cb68-67" aria-hidden="true" tabindex="-1"></a>@fig-pipelines-example&nbsp;(b) shows a more elaborate pipeline that does alternative path branching.</span>
<span id="cb68-68"><a href="#cb68-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-69"><a href="#cb68-69" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fig.align='center', eval = TRUE}</span></span>
<span id="cb68-70"><a href="#cb68-70" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pipelines-state</span></span>
<span id="cb68-71"><a href="#cb68-71" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "`$train()` of the \"Scaling\" PipeOp both transforms data (rectangles) as well as creates a state: the scaling factors, necessary to transform data during prediction."</span></span>
<span id="cb68-72"><a href="#cb68-72" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Traning data is transformed by a Scaling PipeOp, which also sets the state inside the PipeOp."</span></span>
<span id="cb68-73"><a href="#cb68-73" aria-hidden="true" tabindex="-1"></a><span class="co">#| out.width: "70%"</span></span>
<span id="cb68-74"><a href="#cb68-74" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb68-75"><a href="#cb68-75" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/state_graphic.svg"</span>)</span>
<span id="cb68-76"><a href="#cb68-76" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-77"><a href="#cb68-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-78"><a href="#cb68-78" aria-hidden="true" tabindex="-1"></a>When evaluating the performance of an ML process consisting e.g. of preprocessing, followed by model fitting, it is strongly advised to always put the entire preprocessing operation *inside* the resampling loop, as is done here -- <span class="in">`r mlr3pipelines`</span> encourages this more accurate approach.</span>
<span id="cb68-79"><a href="#cb68-79" aria-hidden="true" tabindex="-1"></a>Making a PCA on the entirety of a dataset, followed by resampling a learner on it, would effectively leak information from the training set to the test set, leading to biased results.</span>
<span id="cb68-80"><a href="#cb68-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-81"><a href="#cb68-81" aria-hidden="true" tabindex="-1"></a><span class="fu">## `r mlr3pipelines` by Example {#sec-pipelines-intro}</span></span>
<span id="cb68-82"><a href="#cb68-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-83"><a href="#cb68-83" aria-hidden="true" tabindex="-1"></a>In the following, we provide a brief example of <span class="in">`r mlr3pipelines`</span> to give you a quick idea of what it is capable of.</span>
<span id="cb68-84"><a href="#cb68-84" aria-hidden="true" tabindex="-1"></a>The dataflow programming concept implemented by <span class="in">`r mlr3pipelines`</span> is very intuitive, and seeing a few code snippets will already give you a clear idea of how to use it.</span>
<span id="cb68-85"><a href="#cb68-85" aria-hidden="true" tabindex="-1"></a>In subsequent chapters, we will elaborate on each of the concepts used here.</span>
<span id="cb68-86"><a href="#cb68-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-87"><a href="#cb68-87" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = TRUE}</span></span>
<span id="cb68-88"><a href="#cb68-88" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pipelines-example</span></span>
<span id="cb68-89"><a href="#cb68-89" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout: "[50, 50]"</span></span>
<span id="cb68-90"><a href="#cb68-90" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-valign: bottom</span></span>
<span id="cb68-91"><a href="#cb68-91" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "</span></span>
<span id="cb68-92"><a href="#cb68-92" aria-hidden="true" tabindex="-1"></a><span class="co">#|   Representations of different pipelines.</span></span>
<span id="cb68-93"><a href="#cb68-93" aria-hidden="true" tabindex="-1"></a><span class="co">#|   (a): A simple sequential pipeline that does some preprocessing before feeding data to a learner.</span></span>
<span id="cb68-94"><a href="#cb68-94" aria-hidden="true" tabindex="-1"></a><span class="co">#|        This graphic illustrates our conceptual representation style of a pipeline, which highlights data flows and relevant information about PipeOps.</span></span>
<span id="cb68-95"><a href="#cb68-95" aria-hidden="true" tabindex="-1"></a><span class="co">#|   (b): A pipeline that offers three alternative preprocessing paths:</span></span>
<span id="cb68-96"><a href="#cb68-96" aria-hidden="true" tabindex="-1"></a><span class="co">#|        Data can either be scaled, PCA-transformed, or not transformed at all (\"null\") before being fed into the \"classif.rpart\" learner.</span></span>
<span id="cb68-97"><a href="#cb68-97" aria-hidden="true" tabindex="-1"></a><span class="co">#|        By tuning the hyperparameter of the \"branch\" PipeOp, it is possible to discover which preprocessing operation leads to the best performance.</span></span>
<span id="cb68-98"><a href="#cb68-98" aria-hidden="true" tabindex="-1"></a><span class="co">#|        This graphic shows the output of the `$plot()` method of a Graph object."</span></span>
<span id="cb68-99"><a href="#cb68-99" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-subcap:</span></span>
<span id="cb68-100"><a href="#cb68-100" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - Sequential pipeline.</span></span>
<span id="cb68-101"><a href="#cb68-101" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - Alternative path branching pipeline.</span></span>
<span id="cb68-102"><a href="#cb68-102" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt:</span></span>
<span id="cb68-103"><a href="#cb68-103" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - Sequential pipeline that does scaling, factor encoding, and median imputation before fitting a model.</span></span>
<span id="cb68-104"><a href="#cb68-104" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Pipeline that feeds data into a \"branch\" operator, followed by, alternatively, \"null\", \"pca\", and \"scale\". Outputs of these are combined into \"unbranch\", followed by \"classif.rpart\"."</span></span>
<span id="cb68-105"><a href="#cb68-105" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb68-106"><a href="#cb68-106" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/single_pipe.svg"</span>)</span>
<span id="cb68-107"><a href="#cb68-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-108"><a href="#cb68-108" aria-hidden="true" tabindex="-1"></a><span class="co"># This just produces a plot, not visible to the user.</span></span>
<span id="cb68-109"><a href="#cb68-109" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3pipelines"</span>)</span>
<span id="cb68-110"><a href="#cb68-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-111"><a href="#cb68-111" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"branch"</span>, <span class="fu">c</span>(<span class="st">"nop"</span>, <span class="st">"pca"</span>, <span class="st">"scale"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb68-112"><a href="#cb68-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gunion</span>(<span class="fu">list</span>(</span>
<span id="cb68-113"><a href="#cb68-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"nop"</span>, <span class="at">id =</span> <span class="st">"null1"</span>),</span>
<span id="cb68-114"><a href="#cb68-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"pca"</span>),</span>
<span id="cb68-115"><a href="#cb68-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb68-116"><a href="#cb68-116" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb68-117"><a href="#cb68-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"unbranch"</span>, <span class="fu">c</span>(<span class="st">"nop"</span>, <span class="st">"pca"</span>, <span class="st">"scale"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb68-118"><a href="#cb68-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span>
<span id="cb68-119"><a href="#cb68-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-120"><a href="#cb68-120" aria-hidden="true" tabindex="-1"></a>graph<span class="sc">$</span><span class="fu">plot</span>()</span>
<span id="cb68-121"><a href="#cb68-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-122"><a href="#cb68-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-123"><a href="#cb68-123" aria-hidden="true" tabindex="-1"></a>PipeOps can be easily created using the <span class="in">`r ref("po", "po()")`</span> constructor function.</span>
<span id="cb68-124"><a href="#cb68-124" aria-hidden="true" tabindex="-1"></a>Similar to learners, they have hyperparameters that can be set during construction as well as by using the <span class="in">`$param_set$values`</span> field, as demonstrated in @sec-param-set.</span>
<span id="cb68-125"><a href="#cb68-125" aria-hidden="true" tabindex="-1"></a>The following sets the <span class="in">`scale.`</span> hyperparameter, which corresponds to the <span class="in">`scale.`</span> argument of the <span class="in">`r ref("prcomp", "prcomp()")`</span> function that underlies <span class="in">`r ref("PipeOpPCA", "po(\"pca\")")`</span>:</span>
<span id="cb68-126"><a href="#cb68-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-127"><a href="#cb68-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipeop-quickstart-library, eval = TRUE}</span></span>
<span id="cb68-128"><a href="#cb68-128" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"mlr3pipelines"</span>)</span>
<span id="cb68-129"><a href="#cb68-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-130"><a href="#cb68-130" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">scale. =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-131"><a href="#cb68-131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-132"><a href="#cb68-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-133"><a href="#cb68-133" aria-hidden="true" tabindex="-1"></a>PipeOps can be combined to form Graphs.</span>
<span id="cb68-134"><a href="#cb68-134" aria-hidden="true" tabindex="-1"></a>The simplest way to combine PipeOps is to use the <span class="in">`r ref("concat_graphs", "%&gt;&gt;%")`</span>-operator.</span>
<span id="cb68-135"><a href="#cb68-135" aria-hidden="true" tabindex="-1"></a>To create a Graph that trains a model, combine PipeOps with a <span class="in">`r ref("Learner")`</span>.</span>
<span id="cb68-136"><a href="#cb68-136" aria-hidden="true" tabindex="-1"></a>The <span class="in">`$plot()`</span> method can be used to display the structure of the created Graph.</span>
<span id="cb68-137"><a href="#cb68-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-138"><a href="#cb68-138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipeop-quickstart-graphs-1, eval = TRUE}</span></span>
<span id="cb68-139"><a href="#cb68-139" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span> pca <span class="sc">%&gt;&gt;%</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb68-140"><a href="#cb68-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-141"><a href="#cb68-141" aria-hidden="true" tabindex="-1"></a>graph<span class="sc">$</span><span class="fu">plot</span>(<span class="at">horizontal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-142"><a href="#cb68-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-143"><a href="#cb68-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-144"><a href="#cb68-144" aria-hidden="true" tabindex="-1"></a>A Graph in which the last operation is a <span class="in">`r ref("Learner")`</span> can itself be transformed into a learner, which performs the operations represented by the Graph in order, by using <span class="in">`r ref("as_learner", "as_learner()")`</span>.</span>
<span id="cb68-145"><a href="#cb68-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-146"><a href="#cb68-146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipeop-quickstart-graphlearner-1, eval = TRUE}</span></span>
<span id="cb68-147"><a href="#cb68-147" aria-hidden="true" tabindex="-1"></a>graph_learner <span class="ot">=</span> <span class="fu">as_learner</span>(graph)</span>
<span id="cb68-148"><a href="#cb68-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-149"><a href="#cb68-149" aria-hidden="true" tabindex="-1"></a>graph_learner<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"iris"</span>))</span>
<span id="cb68-150"><a href="#cb68-150" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-151"><a href="#cb68-151" aria-hidden="true" tabindex="-1"></a>Notice how the decision variables in the model are not the columns of the original dataset, but rather the principal components extracted by <span class="in">`r ref("PipeOpPCA", "po(\"pca\")")`</span>.</span>
<span id="cb68-152"><a href="#cb68-152" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipeop-quickstart-graphlearner-1b, eval = TRUE}</span></span>
<span id="cb68-153"><a href="#cb68-153" aria-hidden="true" tabindex="-1"></a>graph_learner<span class="sc">$</span>model<span class="sc">$</span>classif.rpart<span class="sc">$</span>model</span>
<span id="cb68-154"><a href="#cb68-154" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-155"><a href="#cb68-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-156"><a href="#cb68-156" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref("resample", "resample()")`</span>, <span class="in">`r ref("benchmark", "benchmark()")`</span>, and <span class="in">`r ref("tune", "tune()")`</span> work for this object just as for any other <span class="in">`r ref("Learner")`</span>.</span>
<span id="cb68-157"><a href="#cb68-157" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipeop-quickstart-graphlearner-2}</span></span>
<span id="cb68-158"><a href="#cb68-158" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(<span class="fu">tsk</span>(<span class="st">"iris"</span>), graph_learner, <span class="fu">rsmp</span>(<span class="st">"cv"</span>))</span>
<span id="cb68-159"><a href="#cb68-159" aria-hidden="true" tabindex="-1"></a>rr<span class="sc">$</span><span class="fu">aggregate</span>()</span>
<span id="cb68-160"><a href="#cb68-160" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-161"><a href="#cb68-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-162"><a href="#cb68-162" aria-hidden="true" tabindex="-1"></a><span class="fu">## `PipeOp`: Pipeline Operators {#sec-pipelines-pipeops}</span></span>
<span id="cb68-163"><a href="#cb68-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-164"><a href="#cb68-164" aria-hidden="true" tabindex="-1"></a>The most fundamental unit of functionality within <span class="in">`r mlr3pipelines`</span> is the <span class="in">`r ref("PipeOp")`</span>, short for "pipeline operator".</span>
<span id="cb68-165"><a href="#cb68-165" aria-hidden="true" tabindex="-1"></a>It represents a transformative operation on input (for example, a training dataset), resulting in output.</span>
<span id="cb68-166"><a href="#cb68-166" aria-hidden="true" tabindex="-1"></a>Like a learner, it possesses a <span class="in">`$train()`</span> and a <span class="in">`$predict()`</span> function; however, unlike a learner, the <span class="in">`$train()`</span> function can also return a result.</span>
<span id="cb68-167"><a href="#cb68-167" aria-hidden="true" tabindex="-1"></a>The training phase typically generates a particular model of the data, which is saved as internal state.</span>
<span id="cb68-168"><a href="#cb68-168" aria-hidden="true" tabindex="-1"></a>The prediction phase then operates on the prediction data based on the trained model.</span>
<span id="cb68-169"><a href="#cb68-169" aria-hidden="true" tabindex="-1"></a>Therefore, just like a learner, a PipeOp has "parameters" (i.e., the state) that are trained, but also "hyperparameters" that users can set.</span>
<span id="cb68-170"><a href="#cb68-170" aria-hidden="true" tabindex="-1"></a>An illustration of this behavior is the *principal component analysis* operation (<span class="in">`r ref("PipeOpPCA", "po(\"pca\")")`</span>), which we have already seen in the previous section:</span>
<span id="cb68-171"><a href="#cb68-171" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pipeop-intro-1, eval = TRUE}</span></span>
<span id="cb68-172"><a href="#cb68-172" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>)</span>
<span id="cb68-173"><a href="#cb68-173" aria-hidden="true" tabindex="-1"></a>pca</span>
<span id="cb68-174"><a href="#cb68-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-175"><a href="#cb68-175" aria-hidden="true" tabindex="-1"></a>When printed, various aspects of this PipeOp can be observed:</span>
<span id="cb68-176"><a href="#cb68-176" aria-hidden="true" tabindex="-1"></a>The first line tells us the ID of the PipeOp ("<span class="in">`pca`</span>") and that it is not trained yet, therefore lacking a <span class="in">`$state`</span>.</span>
<span id="cb68-177"><a href="#cb68-177" aria-hidden="true" tabindex="-1"></a>The second line would tell us about hyperparameter values.</span>
<span id="cb68-178"><a href="#cb68-178" aria-hidden="true" tabindex="-1"></a>However, this is an empty list here, as we are using the default settings of <span class="in">`r ref("PipeOpPCA", "po(\"pca\")")`</span>.</span>
<span id="cb68-179"><a href="#cb68-179" aria-hidden="true" tabindex="-1"></a>The remaining lines provide information about the input and output types of this PipeOp.</span>
<span id="cb68-180"><a href="#cb68-180" aria-hidden="true" tabindex="-1"></a>The PCA PipeOp takes one input (named "<span class="in">`input`</span>") of type "<span class="in">`Task`</span>", both during training and prediction (thus "<span class="in">`[Task,Task]`</span>).</span>
<span id="cb68-181"><a href="#cb68-181" aria-hidden="true" tabindex="-1"></a>It produces one output (named "<span class="in">`output`</span>"), also of type "<span class="in">`Task`</span>" during both phases.</span>
<span id="cb68-182"><a href="#cb68-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-183"><a href="#cb68-183" aria-hidden="true" tabindex="-1"></a>Training is conducted using the <span class="in">`$train()`</span>-method.</span>
<span id="cb68-184"><a href="#cb68-184" aria-hidden="true" tabindex="-1"></a>Unlike the learner's <span class="in">`$train()`</span> method, we can imagine the PipeOp's <span class="in">`$train()`</span> as potentially having multiple inputs and outputs.</span>
<span id="cb68-185"><a href="#cb68-185" aria-hidden="true" tabindex="-1"></a>This is implemented through <span class="in">`list`</span>s: Both the <span class="in">`$train()`</span> input and output of a PipeOp are always <span class="in">`list`</span>s; the number of elements of these lists depends on the operation.</span>
<span id="cb68-186"><a href="#cb68-186" aria-hidden="true" tabindex="-1"></a>For example, the <span class="in">`r ref("PipeOpPCA", "po(\"pca\")")`</span> PipeOp only transforms a single dataset and is thus invoked with a list containing a single element, the training data task.</span>
<span id="cb68-187"><a href="#cb68-187" aria-hidden="true" tabindex="-1"></a>It returns a modified task with features replaced by their principal components.</span>
<span id="cb68-188"><a href="#cb68-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-189"><a href="#cb68-189" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-003, eval = TRUE}</span></span>
<span id="cb68-190"><a href="#cb68-190" aria-hidden="true" tabindex="-1"></a>poin <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">tsk</span>(<span class="st">"iris"</span>))</span>
<span id="cb68-191"><a href="#cb68-191" aria-hidden="true" tabindex="-1"></a>poout <span class="ot">=</span> pca<span class="sc">$</span><span class="fu">train</span>(poin)</span>
<span id="cb68-192"><a href="#cb68-192" aria-hidden="true" tabindex="-1"></a>poout</span>
<span id="cb68-193"><a href="#cb68-193" aria-hidden="true" tabindex="-1"></a>poout[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">head</span>()</span>
<span id="cb68-194"><a href="#cb68-194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-195"><a href="#cb68-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-196"><a href="#cb68-196" aria-hidden="true" tabindex="-1"></a>During training, the PCA transforms incoming data by rotating it in such a way that features become uncorrelated and are ordered by their contribution to total variance.</span>
<span id="cb68-197"><a href="#cb68-197" aria-hidden="true" tabindex="-1"></a>The rotation matrix is also saved to be applied to new data during the "prediction phase".</span>
<span id="cb68-198"><a href="#cb68-198" aria-hidden="true" tabindex="-1"></a>This allows for "prediction" with single rows of new data, where a row's scores on each of the principal components (the components of the *training* data!) are computed.</span>
<span id="cb68-199"><a href="#cb68-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-200"><a href="#cb68-200" aria-hidden="true" tabindex="-1"></a>Similarly to <span class="in">`$train()`</span>, the <span class="in">`$predict()`</span> function operates on <span class="in">`list`</span>s:</span>
<span id="cb68-201"><a href="#cb68-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-202"><a href="#cb68-202" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-004, eval = TRUE}</span></span>
<span id="cb68-203"><a href="#cb68-203" aria-hidden="true" tabindex="-1"></a>single_line_iris <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"iris"</span>)<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">1</span>)</span>
<span id="cb68-204"><a href="#cb68-204" aria-hidden="true" tabindex="-1"></a>single_line_iris<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb68-205"><a href="#cb68-205" aria-hidden="true" tabindex="-1"></a>poin <span class="ot">=</span> <span class="fu">list</span>(single_line_iris)</span>
<span id="cb68-206"><a href="#cb68-206" aria-hidden="true" tabindex="-1"></a>poout <span class="ot">=</span> pca<span class="sc">$</span><span class="fu">predict</span>(poin)</span>
<span id="cb68-207"><a href="#cb68-207" aria-hidden="true" tabindex="-1"></a>poout[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb68-208"><a href="#cb68-208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-209"><a href="#cb68-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-210"><a href="#cb68-210" aria-hidden="true" tabindex="-1"></a>The internal state that is trained in the <span class="in">`$train()`</span> call is stored in the <span class="in">`$state`</span> field (shown in @fig-pipelines-state). It is analogous to the <span class="in">`$model`</span> field of a learner, and its content depends on the class of PipeOp being used.</span>
<span id="cb68-211"><a href="#cb68-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-212"><a href="#cb68-212" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-005, eval = TRUE}</span></span>
<span id="cb68-213"><a href="#cb68-213" aria-hidden="true" tabindex="-1"></a>pca<span class="sc">$</span>state</span>
<span id="cb68-214"><a href="#cb68-214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-215"><a href="#cb68-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-216"><a href="#cb68-216" aria-hidden="true" tabindex="-1"></a><span class="fu">### Creating `PipeOp`s</span></span>
<span id="cb68-217"><a href="#cb68-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-218"><a href="#cb68-218" aria-hidden="true" tabindex="-1"></a>Each PipeOp is an instance of an <span class="in">`R6`</span> class, with many classes provided by the <span class="in">`r mlr3pipelines`</span> package itself.</span>
<span id="cb68-219"><a href="#cb68-219" aria-hidden="true" tabindex="-1"></a>They can be retrieved from the <span class="in">`r ref("mlr_pipeops")`</span> dictionary, most easily by using the <span class="in">`r ref("po", "po()")`</span> convenience function.</span>
<span id="cb68-220"><a href="#cb68-220" aria-hidden="true" tabindex="-1"></a>A shortcut for creating lists of PipeOps from a vector of names is <span class="in">`r ref("pos", "pos()")`</span>.</span>
<span id="cb68-221"><a href="#cb68-221" aria-hidden="true" tabindex="-1"></a>When retrieving PipeOps from the <span class="in">`r ref("mlr_pipeops")`</span> dictionary, it is also possible to provide additional constructor arguments, such as an ID or hyperparameter settings.</span>
<span id="cb68-222"><a href="#cb68-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-223"><a href="#cb68-223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-2-009, eval = TRUE}</span></span>
<span id="cb68-224"><a href="#cb68-224" aria-hidden="true" tabindex="-1"></a><span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">rank. =</span> <span class="dv">3</span>, <span class="at">id =</span> <span class="st">"pca2"</span>)</span>
<span id="cb68-225"><a href="#cb68-225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-226"><a href="#cb68-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-227"><a href="#cb68-227" aria-hidden="true" tabindex="-1"></a>Note how the printed output for this PipeOp differs from the one shown for <span class="in">`r ref("PipeOpPCA", "po(\"pca\")")`</span> above:</span>
<span id="cb68-228"><a href="#cb68-228" aria-hidden="true" tabindex="-1"></a>It has a different ID, and the fact that the <span class="in">`rank.`</span> setting differs from the default is also shown.</span>
<span id="cb68-229"><a href="#cb68-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-230"><a href="#cb68-230" aria-hidden="true" tabindex="-1"></a>Some PipeOps, in fact, require construction arguments, for example when they are operators that wrap another <span class="in">`mlr3`</span>-object.</span>
<span id="cb68-231"><a href="#cb68-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-pipeops-006, eval = TRUE}</span></span>
<span id="cb68-232"><a href="#cb68-232" aria-hidden="true" tabindex="-1"></a>po_learner <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner"</span>, <span class="at">learner =</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>))</span>
<span id="cb68-233"><a href="#cb68-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-234"><a href="#cb68-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-235"><a href="#cb68-235" aria-hidden="true" tabindex="-1"></a>Calling <span class="in">`po()`</span> by itself prints all available PipeOps.</span>
<span id="cb68-236"><a href="#cb68-236" aria-hidden="true" tabindex="-1"></a>You can use <span class="in">`as.data.table(po())`</span> to get a more detailed list with additional meta-data.</span>
<span id="cb68-237"><a href="#cb68-237" aria-hidden="true" tabindex="-1"></a>The current list of all PipeOps contained in <span class="in">`r mlr3pipelines`</span> with links to their documentation can also be found on the <span class="in">`r link("https://mlr-org.com/pipeops.html", "mlr website")`</span>.</span>
<span id="cb68-238"><a href="#cb68-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 06-pipelines-pipeops-006-1, eval = TRUE}</span></span>
<span id="cb68-239"><a href="#cb68-239" aria-hidden="true" tabindex="-1"></a><span class="fu">po</span>()</span>
<span id="cb68-240"><a href="#cb68-240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-241"><a href="#cb68-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-242"><a href="#cb68-242" aria-hidden="true" tabindex="-1"></a>In some cases where an operation is needed that is not provided by <span class="in">`r mlr3pipelines`</span>, it may be necessary to create custom PipeOps.</span>
<span id="cb68-243"><a href="#cb68-243" aria-hidden="true" tabindex="-1"></a>The <span class="in">`r mlr3pipelines`</span> package contains a vignette on how to do this, which can be accessed by running <span class="in">`vignette("extending", package = "mlr3pipelines")`</span> in <span class="in">`R`</span>, or <span class="in">`r link("https://mlr3pipelines.mlr-org.com/articles/extending.html", "online")`</span>.</span>
<span id="cb68-244"><a href="#cb68-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-245"><a href="#cb68-245" aria-hidden="true" tabindex="-1"></a><span class="fu">## `Graph`: Networks of `PipeOp`s {#sec-pipelines-graphs}</span></span>
<span id="cb68-246"><a href="#cb68-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-247"><a href="#cb68-247" aria-hidden="true" tabindex="-1"></a><span class="fu">### Basics: Building a `Graph`</span></span>
<span id="cb68-248"><a href="#cb68-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-249"><a href="#cb68-249" aria-hidden="true" tabindex="-1"></a>PipeOps are used to represent individual computational steps in ML pipelines.</span>
<span id="cb68-250"><a href="#cb68-250" aria-hidden="true" tabindex="-1"></a>These pipelines themselves are defined by <span class="in">`r ref("Graph")`</span> objects.</span>
<span id="cb68-251"><a href="#cb68-251" aria-hidden="true" tabindex="-1"></a>A Graph is a collection of PipeOps with "edges" that guide the flow of data.</span>
<span id="cb68-252"><a href="#cb68-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-253"><a href="#cb68-253" aria-hidden="true" tabindex="-1"></a>The most convenient way of building a Graph is to connect a sequence of PipeOps using the **`r ref("concat_graphs", "%&gt;&gt;%")`** ("double-arrow") operator.</span>
<span id="cb68-254"><a href="#cb68-254" aria-hidden="true" tabindex="-1"></a>When given two PipeOps, this operator creates a Graph that first executes the left-hand PipeOp, followed by the right-hand one.</span>
<span id="cb68-255"><a href="#cb68-255" aria-hidden="true" tabindex="-1"></a>It can also be used to connect a Graph with a PipeOp, or with another Graph.</span>
<span id="cb68-256"><a href="#cb68-256" aria-hidden="true" tabindex="-1"></a>The following example creates a Graph that first adds a <span class="in">`Petal.Area`</span> feature to a given dataset, and then performs scaling and centering of all numeric features.</span>
<span id="cb68-257"><a href="#cb68-257" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-sequential-01, eval = TRUE}</span></span>
<span id="cb68-258"><a href="#cb68-258" aria-hidden="true" tabindex="-1"></a>po_area <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"mutate"</span>,</span>
<span id="cb68-259"><a href="#cb68-259" aria-hidden="true" tabindex="-1"></a>  <span class="at">mutation =</span> <span class="fu">list</span>(<span class="at">Petal.Area =</span> <span class="sc">~</span>Petal.Width <span class="sc">*</span> Petal.Length)</span>
<span id="cb68-260"><a href="#cb68-260" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-261"><a href="#cb68-261" aria-hidden="true" tabindex="-1"></a>po_scale <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"scale"</span>)</span>
<span id="cb68-262"><a href="#cb68-262" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> po_area <span class="sc">%&gt;&gt;%</span> po_scale</span>
<span id="cb68-263"><a href="#cb68-263" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(gr)</span>
<span id="cb68-264"><a href="#cb68-264" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-265"><a href="#cb68-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-266"><a href="#cb68-266" aria-hidden="true" tabindex="-1"></a>The printer provides information about the layout of the Graph:</span>
<span id="cb68-267"><a href="#cb68-267" aria-hidden="true" tabindex="-1"></a>For each PipOp (column "ID"), it displays information about its state, as well as a list of its successors ("sccssors", i.e. which PipeOps are connected to its output and come directly after it) and its predecessors ("prdcssors", which PipeOps are connected to its input).</span>
<span id="cb68-268"><a href="#cb68-268" aria-hidden="true" tabindex="-1"></a>For this simple Graph, we see that the output of the PipeOp with the ID "<span class="in">`mutate`</span>" is given to the one with ID "<span class="in">`scale`</span>".</span>
<span id="cb68-269"><a href="#cb68-269" aria-hidden="true" tabindex="-1"></a>While the printer of a Graph gives some information about its layout, the most intuitive way of visualizing it is using the <span class="in">`$plot()`</span> function.</span>
<span id="cb68-270"><a href="#cb68-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-271"><a href="#cb68-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-017, eval = TRUE}</span></span>
<span id="cb68-272"><a href="#cb68-272" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">plot</span>(<span class="at">horizontal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-273"><a href="#cb68-273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-274"><a href="#cb68-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-275"><a href="#cb68-275" aria-hidden="true" tabindex="-1"></a><span class="fu">### `Graph`s are Nodes with Edges</span></span>
<span id="cb68-276"><a href="#cb68-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-277"><a href="#cb68-277" aria-hidden="true" tabindex="-1"></a>Internally, Graphs are collections of PipeOps with edges connecting them.</span>
<span id="cb68-278"><a href="#cb68-278" aria-hidden="true" tabindex="-1"></a>The collection of PipeOps inside a Graph can be accessed through the <span class="in">`$pipeops`</span> field.</span>
<span id="cb68-279"><a href="#cb68-279" aria-hidden="true" tabindex="-1"></a>The set of edges in the Graph can be examined through the <span class="in">`$edges`</span> field.</span>
<span id="cb68-280"><a href="#cb68-280" aria-hidden="true" tabindex="-1"></a>It is a <span class="in">`data.table`</span> listing the "source" (<span class="in">`src_id`</span>, <span class="in">`src_channel`</span>) and "destination" (<span class="in">`dst_id`</span>, <span class="in">`dst_channel`</span>) of data flowing along each edge.</span>
<span id="cb68-281"><a href="#cb68-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-282"><a href="#cb68-282" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-018-2, eval = TRUE}</span></span>
<span id="cb68-283"><a href="#cb68-283" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span>pipeops</span>
<span id="cb68-284"><a href="#cb68-284" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span>edges</span>
<span id="cb68-285"><a href="#cb68-285" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-286"><a href="#cb68-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-287"><a href="#cb68-287" aria-hidden="true" tabindex="-1"></a>Besides using the <span class="in">`r ref("concat_graphs", "%&gt;&gt;%")`</span>-operator to create Graphs, it is also possible to create them explicitly.</span>
<span id="cb68-288"><a href="#cb68-288" aria-hidden="true" tabindex="-1"></a>A Graph is empty when first created, and PipeOps can be added using the <span class="in">`$add_pipeop()`</span> method.</span>
<span id="cb68-289"><a href="#cb68-289" aria-hidden="true" tabindex="-1"></a>The <span class="in">`$add_edge()`</span> method is used to create connections between them.</span>
<span id="cb68-290"><a href="#cb68-290" aria-hidden="true" tabindex="-1"></a>The above Graph can therefore also be created in the following way:</span>
<span id="cb68-291"><a href="#cb68-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-292"><a href="#cb68-292" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-016, eval = TRUE}</span></span>
<span id="cb68-293"><a href="#cb68-293" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> Graph<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb68-294"><a href="#cb68-294" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(po_area)</span>
<span id="cb68-295"><a href="#cb68-295" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_pipeop</span>(po_scale)</span>
<span id="cb68-296"><a href="#cb68-296" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">add_edge</span>(<span class="st">"mutate"</span>, <span class="st">"scale"</span>)  <span class="co"># address by PipeOp-ID</span></span>
<span id="cb68-297"><a href="#cb68-297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-298"><a href="#cb68-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-299"><a href="#cb68-299" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb68-300"><a href="#cb68-300" aria-hidden="true" tabindex="-1"></a>Although it is also possible to modify individual PipeOps and edges in a Graph through the <span class="in">`$pipeops`</span> and <span class="in">`$edges`</span> fields, this is not recommended, as no error checking is performed and it may put the Graph in an invalid state.</span>
<span id="cb68-301"><a href="#cb68-301" aria-hidden="true" tabindex="-1"></a>Only do this if you know what you are doing.</span>
<span id="cb68-302"><a href="#cb68-302" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-303"><a href="#cb68-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-304"><a href="#cb68-304" aria-hidden="true" tabindex="-1"></a><span class="fu">### Using a `Graph`</span></span>
<span id="cb68-305"><a href="#cb68-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-306"><a href="#cb68-306" aria-hidden="true" tabindex="-1"></a>A Graph itself has a <span class="in">`$train()`</span> and a <span class="in">`$predict()`</span> method that accept some data and propagate this data through the network of PipeOps, by calling their respective <span class="in">`$train()`</span> and <span class="in">`$predict()`</span> methods.</span>
<span id="cb68-307"><a href="#cb68-307" aria-hidden="true" tabindex="-1"></a>The return value is the output of the PipeOp(s) without outgoing edges.</span>
<span id="cb68-308"><a href="#cb68-308" aria-hidden="true" tabindex="-1"></a>Just like for PipeOps, the output is a list.</span>
<span id="cb68-309"><a href="#cb68-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-310"><a href="#cb68-310" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-019, eval = TRUE}</span></span>
<span id="cb68-311"><a href="#cb68-311" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"iris"</span>))</span>
<span id="cb68-312"><a href="#cb68-312" aria-hidden="true" tabindex="-1"></a>result</span>
<span id="cb68-313"><a href="#cb68-313" aria-hidden="true" tabindex="-1"></a>result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">head</span>()</span>
<span id="cb68-314"><a href="#cb68-314" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">predict</span>(single_line_iris)</span>
<span id="cb68-315"><a href="#cb68-315" aria-hidden="true" tabindex="-1"></a>result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">head</span>()</span>
<span id="cb68-316"><a href="#cb68-316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-317"><a href="#cb68-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-318"><a href="#cb68-318" aria-hidden="true" tabindex="-1"></a><span class="fu">### Debugging a `Graph` with Intermediate Results</span></span>
<span id="cb68-319"><a href="#cb68-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-320"><a href="#cb68-320" aria-hidden="true" tabindex="-1"></a>When Graphs are evaluated, they do not keep intermediate results for memory efficiency, unless the <span class="in">`$keep_results`</span> flag is set first.</span>
<span id="cb68-321"><a href="#cb68-321" aria-hidden="true" tabindex="-1"></a>Inspecting these results may help understanding the inner workings of Graphs, in particular when they produce unexpected results.</span>
<span id="cb68-322"><a href="#cb68-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-323"><a href="#cb68-323" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-021-x, eval = TRUE}</span></span>
<span id="cb68-324"><a href="#cb68-324" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span>keep_results <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb68-325"><a href="#cb68-325" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> gr<span class="sc">$</span><span class="fu">predict</span>(single_line_iris)</span>
<span id="cb68-326"><a href="#cb68-326" aria-hidden="true" tabindex="-1"></a>intermediate <span class="ot">=</span> gr<span class="sc">$</span>pipeops<span class="sc">$</span>mutate<span class="sc">$</span>.result</span>
<span id="cb68-327"><a href="#cb68-327" aria-hidden="true" tabindex="-1"></a>intermediate</span>
<span id="cb68-328"><a href="#cb68-328" aria-hidden="true" tabindex="-1"></a>intermediate[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb68-329"><a href="#cb68-329" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-330"><a href="#cb68-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-331"><a href="#cb68-331" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sequential `Learner`-Pipelines {#sec-pipelines-sequential}</span></span>
<span id="cb68-332"><a href="#cb68-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-333"><a href="#cb68-333" aria-hidden="true" tabindex="-1"></a>Possibly the most common application for <span class="in">`r mlr3pipelines`</span> is to use it to perform basic preprocessing tasks, such as missing value imputation or factor encoding, and to then feed the resulting data into a <span class="in">`r ref("Learner")`</span>.</span>
<span id="cb68-334"><a href="#cb68-334" aria-hidden="true" tabindex="-1"></a>A Graph representing this workflow manipulates data and fits a <span class="in">`r ref("Learner")`</span>-model during training, and uses the fitted model with data that has been similarly preprocessed during prediction.</span>
<span id="cb68-335"><a href="#cb68-335" aria-hidden="true" tabindex="-1"></a>Conceptually, the process may look as shown in @fig-pipelines-pipeline.</span>
<span id="cb68-336"><a href="#cb68-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-337"><a href="#cb68-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-modeling-002, eval = TRUE}</span></span>
<span id="cb68-338"><a href="#cb68-338" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pipelines-pipeline</span></span>
<span id="cb68-339"><a href="#cb68-339" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Conceptualization of training and prediction process inside a sequential learner-pipeline. During training (top row), the data is passed along the preprocessing operators, each of which modifies the data and creates a `$state`. Finally, the learner receives the data and a model is created. During prediction (bottom row), data is likewise transformed by preprocessing operators, using their respective `$state` information in the process. The learner then receives data that has the same format as the data seen during training, and makes a prediction."</span></span>
<span id="cb68-340"><a href="#cb68-340" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Traning data is transformed by a sequential pipeline during training, being passed along a scaling, factor encoding, and median imputation PipeOp and finally given to a learner. Prediction data is passed along the same pipeline, this time containing state and model objects, to create a prediction."</span></span>
<span id="cb68-341"><a href="#cb68-341" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb68-342"><a href="#cb68-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-343"><a href="#cb68-343" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"Figures/pipe_action.svg"</span>)</span>
<span id="cb68-344"><a href="#cb68-344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-345"><a href="#cb68-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-346"><a href="#cb68-346" aria-hidden="true" tabindex="-1"></a>While a <span class="in">`r ref("Learner")`</span> is not a <span class="in">`r ref("PipeOp")`</span> by itself, it can be readily converted into one using <span class="in">`r ref("as_pipeop", "as_pipeop()")`</span>, or alternatively <span class="in">`r ref("PipeOpLearner", "po(\"learner\")")`</span>, which creates a <span class="in">`r ref("PipeOpLearner")`</span>-wrapper-class.</span>
<span id="cb68-347"><a href="#cb68-347" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-modeling-0, eval = TRUE}</span></span>
<span id="cb68-348"><a href="#cb68-348" aria-hidden="true" tabindex="-1"></a>learner_rpart <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"classif.rpart"</span>)</span>
<span id="cb68-349"><a href="#cb68-349" aria-hidden="true" tabindex="-1"></a>po_rpart <span class="ot">=</span> <span class="fu">as_pipeop</span>(learner_rpart)</span>
<span id="cb68-350"><a href="#cb68-350" aria-hidden="true" tabindex="-1"></a>po_rpart <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"learner"</span>, learner_rpart)  <span class="co"># yields the same result</span></span>
<span id="cb68-351"><a href="#cb68-351" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-352"><a href="#cb68-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-353"><a href="#cb68-353" aria-hidden="true" tabindex="-1"></a>However, this conversion is rarely necessary, as the <span class="in">`%&gt;&gt;%`</span>-operator automatically converts learners to PipeOps.</span>
<span id="cb68-354"><a href="#cb68-354" aria-hidden="true" tabindex="-1"></a>The following code creates a Graph that adds a <span class="in">`Petal.Area`</span> feature, followed by fitting a <span class="in">`"classif.rpart"`</span> decision tree model.</span>
<span id="cb68-355"><a href="#cb68-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-356"><a href="#cb68-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-modeling-1, eval = TRUE}</span></span>
<span id="cb68-357"><a href="#cb68-357" aria-hidden="true" tabindex="-1"></a>po_area <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"mutate"</span>,</span>
<span id="cb68-358"><a href="#cb68-358" aria-hidden="true" tabindex="-1"></a>  <span class="at">mutation =</span> <span class="fu">list</span>(<span class="at">Petal.Area =</span> <span class="sc">~</span>Petal.Width <span class="sc">*</span> Petal.Length)</span>
<span id="cb68-359"><a href="#cb68-359" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-360"><a href="#cb68-360" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> po_area <span class="sc">%&gt;&gt;%</span> learner_rpart  <span class="co"># could just as well use po_rpart</span></span>
<span id="cb68-361"><a href="#cb68-361" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">plot</span>(<span class="at">horizontal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-362"><a href="#cb68-362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-363"><a href="#cb68-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-364"><a href="#cb68-364" aria-hidden="true" tabindex="-1"></a>To use a Graph as a learner within <span class="in">`r mlr3`</span>, it is necessary to wrap it in a <span class="in">`r ref("GraphLearner")`</span> object.</span>
<span id="cb68-365"><a href="#cb68-365" aria-hidden="true" tabindex="-1"></a>This is because there are various differences between the classes, most notably the return values of the <span class="in">`$train()`</span> and <span class="in">`$predict()`</span> methods.</span>
<span id="cb68-366"><a href="#cb68-366" aria-hidden="true" tabindex="-1"></a>A Graph can be converted to a <span class="in">`r ref("GraphLearner")`</span> using <span class="in">`r ref("as_learner", "as_learner()")`</span>.</span>
<span id="cb68-367"><a href="#cb68-367" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-modeling-2, eval = TRUE}</span></span>
<span id="cb68-368"><a href="#cb68-368" aria-hidden="true" tabindex="-1"></a>graph_learner <span class="ot">=</span> <span class="fu">as_learner</span>(gr)</span>
<span id="cb68-369"><a href="#cb68-369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-370"><a href="#cb68-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-371"><a href="#cb68-371" aria-hidden="true" tabindex="-1"></a>This learner can be used like any other <span class="in">`r ref("Learner")`</span>.</span>
<span id="cb68-372"><a href="#cb68-372" aria-hidden="true" tabindex="-1"></a>In particular it can be used with <span class="in">`resample()`</span> and <span class="in">`benchmark()`</span>.</span>
<span id="cb68-373"><a href="#cb68-373" aria-hidden="true" tabindex="-1"></a>Let us compare our sequential pipeline with the <span class="in">`"classif.rpart"`</span>-<span class="in">`Learner`</span> by itself:</span>
<span id="cb68-374"><a href="#cb68-374" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-modeling-3}</span></span>
<span id="cb68-375"><a href="#cb68-375" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">=</span> <span class="fu">benchmark_grid</span>(</span>
<span id="cb68-376"><a href="#cb68-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tsks</span>(<span class="st">"iris"</span>),</span>
<span id="cb68-377"><a href="#cb68-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(graph_learner, learner_rpart),</span>
<span id="cb68-378"><a href="#cb68-378" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rsmps</span>(<span class="st">"repeated_cv"</span>)</span>
<span id="cb68-379"><a href="#cb68-379" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-380"><a href="#cb68-380" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(grid)</span>
<span id="cb68-381"><a href="#cb68-381" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>()</span>
<span id="cb68-382"><a href="#cb68-382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-383"><a href="#cb68-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-384"><a href="#cb68-384" aria-hidden="true" tabindex="-1"></a><span class="fu">### Accessing Pipeline Objects</span></span>
<span id="cb68-385"><a href="#cb68-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-386"><a href="#cb68-386" aria-hidden="true" tabindex="-1"></a>The <span class="in">`graph_learner`</span> variable containing the <span class="in">`GraphLearner`</span> object can be used as an ordinary learner.</span>
<span id="cb68-387"><a href="#cb68-387" aria-hidden="true" tabindex="-1"></a>However, it is in fact a wrapper around a Graph, which in turn contains PipeOps, which themselves encompass different components.</span>
<span id="cb68-388"><a href="#cb68-388" aria-hidden="true" tabindex="-1"></a>The following steps demonstrate how to analyze the flow of data in a <span class="in">`GraphLearner`</span>.</span>
<span id="cb68-389"><a href="#cb68-389" aria-hidden="true" tabindex="-1"></a>First, the <span class="in">`$keep_results`</span> flag needs to be set, so intermediate results are retained.</span>
<span id="cb68-390"><a href="#cb68-390" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-modeling-debugging, eval = TRUE}</span></span>
<span id="cb68-391"><a href="#cb68-391" aria-hidden="true" tabindex="-1"></a>graph_learner<span class="sc">$</span>graph_model<span class="sc">$</span>keep_results <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb68-392"><a href="#cb68-392" aria-hidden="true" tabindex="-1"></a>graph_learner<span class="sc">$</span><span class="fu">train</span>(<span class="fu">tsk</span>(<span class="st">"iris"</span>))</span>
<span id="cb68-393"><a href="#cb68-393" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-394"><a href="#cb68-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-395"><a href="#cb68-395" aria-hidden="true" tabindex="-1"></a>The Graph can be accessed through the <span class="in">`$graph_model`</span> field.</span>
<span id="cb68-396"><a href="#cb68-396" aria-hidden="true" tabindex="-1"></a>Using this field, one can now investigate the data fed to the <span class="in">`"classif.rpart"`</span> learner by examining the output of the <span class="in">`"mutate"`</span>-PipeOp.</span>
<span id="cb68-397"><a href="#cb68-397" aria-hidden="true" tabindex="-1"></a>As expected, it includes the additional feature <span class="in">`Petal.Area`</span>.</span>
<span id="cb68-398"><a href="#cb68-398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-modeling-debugging-1, eval = TRUE}</span></span>
<span id="cb68-399"><a href="#cb68-399" aria-hidden="true" tabindex="-1"></a>mutate_result <span class="ot">=</span> graph_learner<span class="sc">$</span>graph_model<span class="sc">$</span>pipeops<span class="sc">$</span>mutate<span class="sc">$</span>.result</span>
<span id="cb68-400"><a href="#cb68-400" aria-hidden="true" tabindex="-1"></a>mutate_result</span>
<span id="cb68-401"><a href="#cb68-401" aria-hidden="true" tabindex="-1"></a>mutate_result[[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">head</span>()</span>
<span id="cb68-402"><a href="#cb68-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-403"><a href="#cb68-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-404"><a href="#cb68-404" aria-hidden="true" tabindex="-1"></a>One can also look at the <span class="in">`$state`</span> of the various PipeOps to investigate the trained model.</span>
<span id="cb68-405"><a href="#cb68-405" aria-hidden="true" tabindex="-1"></a>Here the trained <span class="in">`r ref("LearnerClassifRpart", "lrn(\"classif.rpart\")")`</span> classification tree is interesting.</span>
<span id="cb68-406"><a href="#cb68-406" aria-hidden="true" tabindex="-1"></a>However, it is wrapped inside a <span class="in">`r ref("PipeOpLearner")`</span>: The trained <span class="in">`r ref("Learner")`</span> object has to be extracted before inspection.</span>
<span id="cb68-407"><a href="#cb68-407" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-modeling-debugging-2, eval = TRUE}</span></span>
<span id="cb68-408"><a href="#cb68-408" aria-hidden="true" tabindex="-1"></a>trained_p_rpart <span class="ot">=</span> graph_learner<span class="sc">$</span>graph_model<span class="sc">$</span>pipeops<span class="sc">$</span>classif.rpart</span>
<span id="cb68-409"><a href="#cb68-409" aria-hidden="true" tabindex="-1"></a>trained_l_rpart <span class="ot">=</span> trained_p_rpart<span class="sc">$</span>learner_model</span>
<span id="cb68-410"><a href="#cb68-410" aria-hidden="true" tabindex="-1"></a>trained_l_rpart</span>
<span id="cb68-411"><a href="#cb68-411" aria-hidden="true" tabindex="-1"></a>trained_l_rpart<span class="sc">$</span>model</span>
<span id="cb68-412"><a href="#cb68-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-413"><a href="#cb68-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-414"><a href="#cb68-414" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb68-415"><a href="#cb68-415" aria-hidden="true" tabindex="-1"></a>A more straightforward approach to access the learner at the end of a Graph in a <span class="in">`r ref("GraphLearner")`</span> is to use the <span class="in">`$base_learner()`</span> method.</span>
<span id="cb68-416"><a href="#cb68-416" aria-hidden="true" tabindex="-1"></a>One can therefore also use <span class="in">`graph_learner$base_learner()$model`</span> to access the trained model.</span>
<span id="cb68-417"><a href="#cb68-417" aria-hidden="true" tabindex="-1"></a>However, this method does not work for ensembling <span class="in">`r ref("GraphLearner")`</span> objects containing multiple learners.</span>
<span id="cb68-418"><a href="#cb68-418" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-419"><a href="#cb68-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-420"><a href="#cb68-420" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pipeline Hyperparameters {#sec-pipelines-hyperparameters}</span></span>
<span id="cb68-421"><a href="#cb68-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-422"><a href="#cb68-422" aria-hidden="true" tabindex="-1"></a>Much like <span class="in">`r ref("Learner")`</span>s, PipeOps have *hyperparameters*, provided by the <span class="in">`r mlr3book::ref_pkg("paradox")`</span> package.</span>
<span id="cb68-423"><a href="#cb68-423" aria-hidden="true" tabindex="-1"></a>These can be accessed through the <span class="in">`$param_set`</span> field, providing information about the adjustable hyperparameters.</span>
<span id="cb68-424"><a href="#cb68-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-425"><a href="#cb68-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-032, eval = TRUE}</span></span>
<span id="cb68-426"><a href="#cb68-426" aria-hidden="true" tabindex="-1"></a>po_pca <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>)</span>
<span id="cb68-427"><a href="#cb68-427" aria-hidden="true" tabindex="-1"></a>po_pca<span class="sc">$</span>param_set</span>
<span id="cb68-428"><a href="#cb68-428" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-429"><a href="#cb68-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-430"><a href="#cb68-430" aria-hidden="true" tabindex="-1"></a>Similar to <span class="in">`r ref("Learner")`</span> objects, the <span class="in">`$param_set$values`</span> field can be used to alter hyperparameter settings; alternatively, hyperparameter values can be set using the <span class="in">`$param_set$set_values()`</span> function or during construction.</span>
<span id="cb68-431"><a href="#cb68-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-432"><a href="#cb68-432" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-033, eval = TRUE}</span></span>
<span id="cb68-433"><a href="#cb68-433" aria-hidden="true" tabindex="-1"></a>po_pca<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>center <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb68-434"><a href="#cb68-434" aria-hidden="true" tabindex="-1"></a><span class="co"># More convenient when multiple hyperparameters need to be set:</span></span>
<span id="cb68-435"><a href="#cb68-435" aria-hidden="true" tabindex="-1"></a>po_pca<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">set_values</span>(<span class="at">center =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-436"><a href="#cb68-436" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternatively:</span></span>
<span id="cb68-437"><a href="#cb68-437" aria-hidden="true" tabindex="-1"></a>po_pca <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">center =</span> <span class="cn">FALSE</span>)</span>
<span id="cb68-438"><a href="#cb68-438" aria-hidden="true" tabindex="-1"></a><span class="co"># All of these have the same result:</span></span>
<span id="cb68-439"><a href="#cb68-439" aria-hidden="true" tabindex="-1"></a>po_pca<span class="sc">$</span>param_set<span class="sc">$</span>values</span>
<span id="cb68-440"><a href="#cb68-440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-441"><a href="#cb68-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-442"><a href="#cb68-442" aria-hidden="true" tabindex="-1"></a>Each PipeOp can have its own individual hyperparameters, which are collected together in the Graph's <span class="in">`$param_set`</span>.</span>
<span id="cb68-443"><a href="#cb68-443" aria-hidden="true" tabindex="-1"></a>A PipeOp's parameter names are prefixed with its ID to avoid parameter name clashes.</span>
<span id="cb68-444"><a href="#cb68-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-445"><a href="#cb68-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-035, eval = TRUE}</span></span>
<span id="cb68-446"><a href="#cb68-446" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> po_pca <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"scale"</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-447"><a href="#cb68-447" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span>param_set</span>
<span id="cb68-448"><a href="#cb68-448" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-449"><a href="#cb68-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-450"><a href="#cb68-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-451"><a href="#cb68-451" aria-hidden="true" tabindex="-1"></a>The hyperparameter settings of a <span class="in">`r ref("GraphLearner")`</span> can be changed directly (recommended), but they can also be accessed indirectly by reading (and modifying) the underlying Graph's, PipeOp's, or learner's hyperparameters.</span>
<span id="cb68-452"><a href="#cb68-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-453"><a href="#cb68-453" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb68-454"><a href="#cb68-454" aria-hidden="true" tabindex="-1"></a>When a learner is encapsulated in a <span class="in">`r ref("PipeOpLearner")`</span> through <span class="in">`as_pipeop()`</span>, its <span class="in">`ParamSet`</span> is exposed.</span>
<span id="cb68-455"><a href="#cb68-455" aria-hidden="true" tabindex="-1"></a>Once this PipeOp becomes part of a Graph, the hyperparameters are prefixed with the PipeOp's ID, which by default is the learner's ID.</span>
<span id="cb68-456"><a href="#cb68-456" aria-hidden="true" tabindex="-1"></a>When a Graph is converted back into a learner using <span class="in">`as_learner()`</span>, the resulting <span class="in">`r ref("GraphLearner")`</span> retains the Graph's <span class="in">`r ref("ParamSet")`</span>.</span>
<span id="cb68-457"><a href="#cb68-457" aria-hidden="true" tabindex="-1"></a>Therefore the original learner's hyperparameters are now prefixed with the learner's ID.</span>
<span id="cb68-458"><a href="#cb68-458" aria-hidden="true" tabindex="-1"></a>For example, if a <span class="in">`r ref("LearnerClassifRpart", "lrn(\"classif.rpart\")")`</span> is encapsulated in a Graph, its <span class="in">`maxdepth`</span> hyperparameter becomes <span class="in">`classif.rpart.maxdepth`</span>.</span>
<span id="cb68-459"><a href="#cb68-459" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-460"><a href="#cb68-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-461"><a href="#cb68-461" aria-hidden="true" tabindex="-1"></a><span class="fu">### IDs and Name Clashes</span></span>
<span id="cb68-462"><a href="#cb68-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-463"><a href="#cb68-463" aria-hidden="true" tabindex="-1"></a>To ensure that PipeOps can be accessed by their ID within Graphs, their IDs within a Graph must be unique.</span>
<span id="cb68-464"><a href="#cb68-464" aria-hidden="true" tabindex="-1"></a>IDs can be set during construction using the <span class="in">`id`</span> argument of <span class="in">`po()`</span>, or they can be modified for existing PipeOps.</span>
<span id="cb68-465"><a href="#cb68-465" aria-hidden="true" tabindex="-1"></a>For PipeOps already in a Graph, the <span class="in">`$set_names()`</span> method can also be employed to change IDs, although this should rarely be necessary.</span>
<span id="cb68-466"><a href="#cb68-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-467"><a href="#cb68-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r 05-pipelines-in-depth-040, eval = TRUE}</span></span>
<span id="cb68-468"><a href="#cb68-468" aria-hidden="true" tabindex="-1"></a><span class="co"># Without the `id` argument, this would lead to a name collision error</span></span>
<span id="cb68-469"><a href="#cb68-469" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">=</span> <span class="fu">po</span>(<span class="st">"pca"</span>) <span class="sc">%&gt;&gt;%</span> <span class="fu">po</span>(<span class="st">"pca"</span>, <span class="at">id =</span> <span class="st">"pca2"</span>)</span>
<span id="cb68-470"><a href="#cb68-470" aria-hidden="true" tabindex="-1"></a>gr</span>
<span id="cb68-471"><a href="#cb68-471" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span><span class="fu">set_names</span>(</span>
<span id="cb68-472"><a href="#cb68-472" aria-hidden="true" tabindex="-1"></a>  <span class="at">old =</span> <span class="fu">c</span>(<span class="st">"pca"</span>, <span class="st">"pca2"</span>),</span>
<span id="cb68-473"><a href="#cb68-473" aria-hidden="true" tabindex="-1"></a>  <span class="at">new =</span> <span class="fu">c</span>(<span class="st">"pca_1"</span>, <span class="st">"pca_2"</span>)</span>
<span id="cb68-474"><a href="#cb68-474" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-475"><a href="#cb68-475" aria-hidden="true" tabindex="-1"></a>gr</span>
<span id="cb68-476"><a href="#cb68-476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-477"><a href="#cb68-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-478"><a href="#cb68-478" aria-hidden="true" tabindex="-1"></a>:::{.callout-warning}</span>
<span id="cb68-479"><a href="#cb68-479" aria-hidden="true" tabindex="-1"></a>Avoid changing the ID of a PipeOp that is already in a Graph through <span class="in">`graph$pipeops$&lt;old_id&gt;$id = &lt;new_id&gt;`</span>, as this will only alter the PipeOp's record of its own ID, not the Graph's record.</span>
<span id="cb68-480"><a href="#cb68-480" aria-hidden="true" tabindex="-1"></a>This would result in undefined behavior for the Graph.</span>
<span id="cb68-481"><a href="#cb68-481" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-482"><a href="#cb68-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-483"><a href="#cb68-483" aria-hidden="true" tabindex="-1"></a><span class="fu">## Recap</span></span>
<span id="cb68-484"><a href="#cb68-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-485"><a href="#cb68-485" aria-hidden="true" tabindex="-1"></a><span class="in">`r ref_pkg("mlr3pipelines")`</span> provides <span class="in">`r ref("PipeOp")`</span> objects that provide preprocessing, postprocessing, and ensembling operations that can be created using the <span class="in">`r ref("po", "po()")`</span> constructor function.</span>
<span id="cb68-486"><a href="#cb68-486" aria-hidden="true" tabindex="-1"></a>PipeOps have an ID and hyperparameters that can be set during construction and can be modified later.</span>
<span id="cb68-487"><a href="#cb68-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-488"><a href="#cb68-488" aria-hidden="true" tabindex="-1"></a>PipeOps are concatenated using the <span class="in">`r ref("concat_graphs", "%&gt;&gt;%")`</span>-operator to form <span class="in">`r ref("Graph")`</span> objects.</span>
<span id="cb68-489"><a href="#cb68-489" aria-hidden="true" tabindex="-1"></a>Graphs can be converted to <span class="in">`r ref("Learner")`</span> objects using the <span class="in">`r ref("as_learner")`</span> function, after which they can be benchmarked and tuned using the tools provided by <span class="in">`r ref_pkg("mlr3")`</span>.</span>
<span id="cb68-490"><a href="#cb68-490" aria-hidden="true" tabindex="-1"></a>Various standard Graphs are provided by the <span class="in">`r ref("ppl", "ppl()")`</span> constructor function.</span>
<span id="cb68-491"><a href="#cb68-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-492"><a href="#cb68-492" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb68-493"><a href="#cb68-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-494"><a href="#cb68-494" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Create a learner containing a Graph that first imputes missing values using <span class="in">`r ref("PipeOpImputeOOR", "po(\"imputeoor\")")`</span>, standardizes the data using <span class="in">`r ref("PipeOpScale", "po(\"scale\")")`</span>, and then fits a logistic linear model using <span class="in">`r ref("LearnerClassifLogReg", "lrn(\"classif.log_reg\")")`</span>.</span>
<span id="cb68-495"><a href="#cb68-495" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Train the Graph created in the previous exercise on the <span class="in">`r ref("mlr_tasks_pima", "tsk(\"pima\")")`</span> task and display the coefficients of the resulting model.</span>
<span id="cb68-496"><a href="#cb68-496" aria-hidden="true" tabindex="-1"></a>  What are two different ways to access the model?</span>
<span id="cb68-497"><a href="#cb68-497" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Verify that the "<span class="in">`age`</span>" column of the input task of <span class="in">`r ref("LearnerClassifLogReg", "lrn(\"classif.log_reg\")")`</span> from the previous exercise is indeed standardized.</span>
<span id="cb68-498"><a href="#cb68-498" aria-hidden="true" tabindex="-1"></a>  One way to do this would be to look at the <span class="in">`$data`</span> field of the <span class="in">`r ref("LearnerClassifLogReg", "lrn(\"classif.log_reg\")")`</span> model; however, that is specific to that particular learner and does not work in general.</span>
<span id="cb68-499"><a href="#cb68-499" aria-hidden="true" tabindex="-1"></a>  What would be a different, more general way to do this?</span>
<span id="cb68-500"><a href="#cb68-500" aria-hidden="true" tabindex="-1"></a>  Hint: use the <span class="in">`$keep_results`</span> flag.</span>
<span id="cb68-501"><a href="#cb68-501" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Consider the <span class="in">`r ref("PipeOpSelect", "po(\"select\")")`</span> in @sec-pipelines-stack that is used to only keep the columns ending in "<span class="in">`M`</span>".</span>
<span id="cb68-502"><a href="#cb68-502" aria-hidden="true" tabindex="-1"></a>  If the classification task had more than two classes, it would be more appropriate to list the single class we *do not* want to keep, instead of listing all the classes we do want to keep.</span>
<span id="cb68-503"><a href="#cb68-503" aria-hidden="true" tabindex="-1"></a>  How would you do this, using the <span class="in">`r ref("Selector")`</span> functions provided by <span class="in">`r ref_pkg("mlr3pipelines")`</span>?</span>
<span id="cb68-504"><a href="#cb68-504" aria-hidden="true" tabindex="-1"></a>  (Note: The <span class="in">`r ref("LearnerClassifLogReg", "lrn(\"classif.log_reg\")")`</span> learner used in @sec-pipelines-stack cannot handle more than two classes. To build the entire stack, you will need to use a different learner, such as <span class="in">`r ref("LearnerClassifMultinom", "lrn(\"classif.multinom\")")`</span>.)</span>
<span id="cb68-505"><a href="#cb68-505" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>How would you solve the previous exercise without even explicitly naming the class you want to exclude, so that your Graph works for any classification task?</span>
<span id="cb68-506"><a href="#cb68-506" aria-hidden="true" tabindex="-1"></a>  Hint: look at the <span class="in">`selector_subsample`</span> in @sec-pipelines-bagging.</span>
<span id="cb68-507"><a href="#cb68-507" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Use the <span class="in">`r ref("PipeOpImputeLearner", "po(\"imputelearner\")")`</span> PipeOp to impute missing values in the <span class="in">`r ref("mlr_tasks_penguins", "tsk(\"penguins\")")`</span> task using learners based on <span class="in">`r ref("ranger::ranger")`</span>.</span>
<span id="cb68-508"><a href="#cb68-508" aria-hidden="true" tabindex="-1"></a>  Hint 1: you will need to use <span class="in">`r ref("PipeOpImputeLearner", "po(\"imputelearner\")")`</span> twice, once for numeric features with <span class="in">`r ref("LearnerRegrRanger", "lrn(\"regr.ranger\")")`</span>, and once for categorical features with <span class="in">`r ref("LearnerClassifRanger", "lrn(\"classif.ranger\")")`</span>.</span>
<span id="cb68-509"><a href="#cb68-509" aria-hidden="true" tabindex="-1"></a>  Using the <span class="in">`affect_columns`</span> argument of <span class="in">`r ref("PipeOpImputeLearner", "po(\"imputelearner\")")`</span> will help you here.</span>
<span id="cb68-510"><a href="#cb68-510" aria-hidden="true" tabindex="-1"></a>  Hint 2: <span class="in">`r ref("ranger::ranger")`</span> itself does not support missing values, but it is trained on all the features of <span class="in">`r ref("mlr_tasks_penguins", "tsk(\"penguins\")")`</span> that it is not currently imputing, some of which will also contain missings.</span>
<span id="cb68-511"><a href="#cb68-511" aria-hidden="true" tabindex="-1"></a>  A simple way to avoid problems here is to use <span class="in">`r ref("pipeline_robustify", "ppl(\"robustify\")")`</span> *inside* <span class="in">`r ref("PipeOpImputeLearner", "po(\"imputelearner\")")`</span> next to the <span class="in">`r ref("ranger::ranger")`</span> learner.</span>
<span id="cb68-512"><a href="#cb68-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-513"><a href="#cb68-513" aria-hidden="true" tabindex="-1"></a>::: {.content-visible when-format="html"}</span>
<span id="cb68-514"><a href="#cb68-514" aria-hidden="true" tabindex="-1"></a><span class="in">`r citeas(chapter)`</span></span>
<span id="cb68-515"><a href="#cb68-515" aria-hidden="true" tabindex="-1"></a>:::</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">All content licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> <br> © Bernd Bischl, Raphael Sonabend, Lars Kotthoff, Michel Lang.</div>   
    <div class="nav-footer-center"><a href="https://mlr-org.com">Website</a> | <a href="https://github.com/mlr-org/mlr3book">GitHub</a> | <a href="https://mlr-org.com/gallery">Gallery</a> | <a href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/">Mattermost</a></div>
    <div class="nav-footer-right">Built with <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>


<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>